# 成绩截图显示问题 - 完整调试步骤

## 📋 目录

1. [调试准备](#调试准备)
2. [前端调试步骤](#前端调试步骤)
3. [后端调试步骤](#后端调试步骤)
4. [数据库检查](#数据库检查)
5. [常见问题排查](#常见问题排查)
6. [调试信息收集模板](#调试信息收集模板)

---

## 🔧 调试准备

### 1. 重启后端服务

```bash
# 停止后端服务（如果正在运行）
# 重新启动后端服务
```

**目的**：加载新的后端日志代码

### 2. 打开浏览器控制台

1. 打开浏览器（Chrome/Edge）
2. 按 `F12` 打开开发者工具
3. 切换到 `Console` 标签
4. 点击 `Clear console` 按钮清空控制台
5. 确保控制台过滤器设置为 `All levels`（显示所有日志级别）

---

## 🖥️ 前端调试步骤

### 步骤1: 登录班委账号

1. 访问系统登录页面
2. 使用班委账号登录
3. 进入"综合测评管理" -> "班委审核"页面

### 步骤2: 点击"审核"按钮

1. 在班委审核列表中，找到一条记录
2. 点击该记录的"审核"按钮
3. **立即查看控制台输出**

### 步骤3: 查看前端控制台输出

#### ✅ 正常情况的输出示例

```javascript
=== [班委审核] 开始加载填报详情 ===
填报记录ID (submissionId): 8
后端返回的完整数据: {code: 200, msg: "查询成功", data: {...}}
填报详情 (submissionDetail): {id: 8, studentId: 103, studentName: "张三", ...}
详情列表 (details): [
  {id: 94, ruleSnapshot: "...", ...},
  {id: 95, ruleSnapshot: "...", ...},
  ...
]

--- 开始查找智育维度的detailId ---
共有 5 个维度详情

检查第 1 个详情: {id: 94, submissionId: 8, ruleSnapshot: "...", ...}
  规则快照 (ruleSnapshot): {
    dimensionType: 1,
    dimension: "intellectual",
    dimensionName: "智育",
    ...
  }
  dimensionType: 1
  dimension: intellectual
  ✅ 找到智育维度！detailId = 94

✅ 找到智育维度的detailId: 94

=== [GradeScreenshotViewer] detailId 变化 ===
新的 detailId: 94

=== [GradeScreenshotViewer] 开始加载成绩截图 ===
智育维度 detailId: 94
请求接口: GET /evaluation/attachment/grade-screenshot/94
后端返回的原始响应: {
  code: 200,
  msg: "操作成功",
  data: [
    {
      id: 94,
      detailId: 94,
      fileName: "0a83ec3709135c1c5e08d8a7592ea50a_20251103182220A001.jpg",
      originalName: "成绩截图.jpg",
      url: "http://localhost:8080/profile/upload/2025/11/03/0a83ec3709135c1c5e08d8a7592ea50a_20251103182220A001.jpg",
      fileSize: 160543,
      attachmentType: "GRADE_SCREENSHOT",
      ...
    }
  ]
}
✅ 成功加载成绩截图，数量: 1
成绩截图列表:
  [1] 文件名: 0a83ec3709135c1c5e08d8a7592ea50a_20251103182220A001.jpg
      URL: http://localhost:8080/profile/upload/2025/11/03/0a83ec3709135c1c5e08d8a7592ea50a_20251103182220A001.jpg
      文件大小: 156.78 KB
      附件类型: GRADE_SCREENSHOT
      detailId: 94
=== [GradeScreenshotViewer] 加载完成 ===
```

#### ❌ 异常情况1: 未找到智育维度

```javascript
=== [班委审核] 开始加载填报详情 ===
填报记录ID (submissionId): 8
...
--- 开始查找智育维度的detailId ---
共有 5 个维度详情

检查第 1 个详情: {...}
  规则快照 (ruleSnapshot): {dimensionType: 2, ...}
  dimensionType: 2
  dimension: moral
  ❌ 不是智育维度，跳过

检查第 2 个详情: {...}
  ...

❌ 未找到智育维度的detailId
⚠️ 未找到智育维度的detailId，成绩截图将无法显示
```

**问题**：所有详情中都没有 `dimensionType: 1` 或 `dimension: 'intellectual'`

**请记录**：
- `submissionId` 是多少？
- `details` 数组有多少个元素？
- 每个 `detail` 的 `ruleSnapshot` 内容是什么？

#### ❌ 异常情况2: 后端返回空列表

```javascript
=== [GradeScreenshotViewer] 开始加载成绩截图 ===
智育维度 detailId: 94
请求接口: GET /evaluation/attachment/grade-screenshot/94
后端返回的原始响应: {code: 200, msg: "操作成功", data: []}
✅ 成功加载成绩截图，数量: 0
⚠️ 后端返回的成绩截图列表为空
可能的原因:
  1. 学生确实没有上传成绩截图
  2. detailId 不正确
  3. 附件的 attachmentType 不是 GRADE_SCREENSHOT
  4. 附件的 detailId 与当前 detailId 不匹配
=== [GradeScreenshotViewer] 加载完成 ===
```

**问题**：后端返回了空数组

**请记录**：
- `detailId` 是多少？
- 继续查看后端日志

---

## 🖧 后端调试步骤

### 步骤1: 打开后端控制台

打开后端控制台（IDEA/Eclipse的Console窗口）

### 步骤2: 查看后端日志输出

#### ✅ 正常情况的输出示例

```
INFO  c.r.w.c.e.EvaluationAttachmentController - === [后端] 收到查询成绩截图请求 ===
INFO  c.r.w.c.e.EvaluationAttachmentController - 请求参数 detailId: 94
INFO  c.r.s.s.i.EvaluationAttachmentServiceImpl - --- [Service层] 查询附件 ---
INFO  c.r.s.s.i.EvaluationAttachmentServiceImpl - detailId: 94, attachmentType: GRADE_SCREENSHOT
INFO  c.r.s.s.i.EvaluationAttachmentServiceImpl - ✅ Mapper 返回 1 条记录
INFO  c.r.w.c.e.EvaluationAttachmentController - ✅ 查询成功，返回 1 张成绩截图
INFO  c.r.w.c.e.EvaluationAttachmentController - 成绩截图列表:
INFO  c.r.w.c.e.EvaluationAttachmentController -   [1] ID: 94, 文件名: 0a83ec3709135c1c5e08d8a7592ea50a_20251103182220A001.jpg, URL: http://localhost:8080/profile/upload/2025/11/03/0a83ec3709135c1c5e08d8a7592ea50a_20251103182220A001.jpg, detailId: 94, attachmentType: GRADE_SCREENSHOT
```

#### ❌ 异常情况: Mapper返回0条记录

```
INFO  c.r.w.c.e.EvaluationAttachmentController - === [后端] 收到查询成绩截图请求 ===
INFO  c.r.w.c.e.EvaluationAttachmentController - 请求参数 detailId: 94
INFO  c.r.s.s.i.EvaluationAttachmentServiceImpl - --- [Service层] 查询附件 ---
INFO  c.r.s.s.i.EvaluationAttachmentServiceImpl - detailId: 94, attachmentType: GRADE_SCREENSHOT
INFO  c.r.s.s.i.EvaluationAttachmentServiceImpl - ✅ Mapper 返回 0 条记录
WARN  c.r.s.s.i.EvaluationAttachmentServiceImpl - ⚠️ 未找到匹配的附件记录
WARN  c.r.s.s.i.EvaluationAttachmentServiceImpl - 请检查数据库 evaluation_attachment 表:
WARN  c.r.s.s.i.EvaluationAttachmentServiceImpl -   SELECT * FROM evaluation_attachment WHERE detail_id = 94 AND attachment_type = 'GRADE_SCREENSHOT'
INFO  c.r.w.c.e.EvaluationAttachmentController - ✅ 查询成功，返回 0 张成绩截图
WARN  c.r.w.c.e.EvaluationAttachmentController - ⚠️ 未找到成绩截图，detailId: 94
```

**问题**：数据库中没有该 `detailId` 的成绩截图附件

**请继续**：执行数据库检查步骤

---

## 🗄️ 数据库检查

### 步骤1: 连接数据库

使用MySQL客户端或Navicat连接到数据库

### 步骤2: 执行SQL查询

#### 查询1: 检查该detailId的所有附件

```sql
SELECT * FROM evaluation_attachment WHERE detail_id = 94;
```

**预期结果**：应该至少有1条记录，且 `attachment_type = 'GRADE_SCREENSHOT'`

#### 查询2: 检查该detailId的成绩截图附件

```sql
SELECT * FROM evaluation_attachment 
WHERE detail_id = 94 AND attachment_type = 'GRADE_SCREENSHOT';
```

**预期结果**：应该至少有1条记录

#### 查询3: 检查所有成绩截图附件

```sql
SELECT * FROM evaluation_attachment WHERE attachment_type = 'GRADE_SCREENSHOT';
```

**目的**：查看系统中是否有其他成绩截图附件

#### 查询4: 检查该submissionId的所有详情

```sql
SELECT id, submission_id, rule_snapshot 
FROM evaluation_submission_detail 
WHERE submission_id = 8;
```

**目的**：查看该填报记录有哪些维度详情，以及 `rule_snapshot` 的内容

#### 查询5: 检查智育维度的详情

```sql
SELECT id, submission_id, rule_snapshot 
FROM evaluation_submission_detail 
WHERE submission_id = 8 
  AND (rule_snapshot LIKE '%"dimensionType":1%' OR rule_snapshot LIKE '%"dimension":"intellectual"%');
```

**目的**：查找智育维度的详情ID

---

## 🔍 常见问题排查

### 问题1: 未找到智育维度的detailId

**症状**：
```
❌ 未找到智育维度的detailId
⚠️ 未找到智育维度的detailId，成绩截图将无法显示
```

**可能原因**：
1. `submissionDetail.details` 为空
2. 所有详情的 `ruleSnapshot` 中没有 `dimensionType: 1` 或 `dimension: 'intellectual'`
3. `ruleSnapshot` 字段格式错误，无法解析

**排查步骤**：
1. 检查前端控制台的 `详情列表 (details):` 输出
2. 检查每个详情的 `ruleSnapshot` 内容
3. 执行数据库查询5，检查智育维度的详情是否存在

**解决方案**：
- 如果 `details` 为空，检查后端 `getSubmission` 接口是否正确加载了详情
- 如果 `ruleSnapshot` 格式错误，检查数据库中的 `rule_snapshot` 字段
- 如果没有智育维度的详情，需要重新提交填报记录

---

### 问题2: 后端返回0条记录

**症状**：
```
⚠️ 后端返回的成绩截图列表为空
```

**可能原因**：
1. 数据库中没有该 `detailId` 的成绩截图附件
2. 附件的 `attachmentType` 不是 `GRADE_SCREENSHOT`
3. 附件的 `detailId` 与请求的 `detailId` 不匹配

**排查步骤**：
1. 执行数据库查询1和2，检查附件是否存在
2. 检查附件的 `attachment_type` 字段值
3. 检查附件的 `detail_id` 字段值

**解决方案**：
- 如果数据库中没有附件记录，需要重新提交填报记录
- 如果 `attachment_type` 不正确，可能是保存时出错，需要检查保存逻辑
- 如果 `detail_id` 不匹配，可能是保存时使用了错误的 `detailId`

---

### 问题3: 图片无法显示

**症状**：
- 控制台显示"✅ 成功加载成绩截图，数量: 1"
- 但页面上看不到图片

**可能原因**：
1. 图片URL无法访问（404错误）
2. 图片路径不正确
3. MinIO服务未启动
4. CSS样式问题导致图片被隐藏

**排查步骤**：
1. 复制控制台输出的图片URL
2. 在浏览器新标签页中直接访问该URL
3. 检查是否返回404错误
4. 检查MinIO服务是否正常运行
5. 使用浏览器开发者工具检查元素，查看图片元素是否存在

**解决方案**：
- 如果URL返回404，检查文件是否存在于服务器
- 如果MinIO未启动，启动MinIO服务
- 如果CSS问题，检查样式定义

---

## 📝 调试信息收集模板

请将以下信息提供给开发人员：

### 1. 前端控制台完整输出

```
[请粘贴从"=== [班委审核] 开始加载填报详情 ===" 到 "=== [GradeScreenshotViewer] 加载完成 ===" 的所有输出]
```

### 2. 后端日志完整输出

```
[请粘贴从"=== [后端] 收到查询成绩截图请求 ===" 到成绩截图列表的所有输出]
```

### 3. 数据库查询结果

#### 查询1结果（该detailId的所有附件）
```sql
SELECT * FROM evaluation_attachment WHERE detail_id = [detailId];
```
结果：
```
[请粘贴查询结果]
```

#### 查询2结果（该detailId的成绩截图附件）
```sql
SELECT * FROM evaluation_attachment 
WHERE detail_id = [detailId] AND attachment_type = 'GRADE_SCREENSHOT';
```
结果：
```
[请粘贴查询结果]
```

#### 查询4结果（该submissionId的所有详情）
```sql
SELECT id, submission_id, rule_snapshot 
FROM evaluation_submission_detail 
WHERE submission_id = [submissionId];
```
结果：
```
[请粘贴查询结果]
```

### 4. 页面截图

[请提供成绩截图核验区域的截图]

### 5. 关键参数

- `submissionId`: ___________
- `intellectualDetailId`: ___________
- 成绩截图数量: ___________
- 图片URL: ___________

---

## ✅ 调试完成检查清单

- [ ] 前端控制台显示"✅ 找到智育维度的detailId: XX"
- [ ] 前端控制台显示"✅ 成功加载成绩截图，数量: X"
- [ ] 后端日志显示"✅ 查询成功，返回 X 张成绩截图"
- [ ] 数据库中存在对应的附件记录
- [ ] 页面上可以看到成绩截图
- [ ] 可以点击图片预览大图

---

**如果所有检查项都通过，说明成绩截图功能正常！** 🎉

