# 删除草稿功能 + 自动加载历史记录

## 需求描述

用户希望简化填报流程：
1. **删除本地草稿功能**：不再使用localStorage保存草稿，所有数据都从数据库加载
2. **自动加载历史记录**：用户打开填报页面时，自动加载该学年学期的已有提交记录
3. **保持更新策略**：提交时仍然使用"删除旧记录 + 插入新记录"的策略

---

## 实现方案

### 后端修改

#### 1. Service接口 (`IEvaluationSubmissionService.java`)

**新增方法**：
```java
/**
 * 查询学生在指定学年学期的提交记录
 * 
 * @param userId 用户ID
 * @param academicYear 学年
 * @param semester 学期
 * @return 提交记录，如果不存在则返回null
 */
public EvaluationSubmission selectByUserAndSemester(Long userId, String academicYear, Integer semester);
```

#### 2. Service实现 (`EvaluationSubmissionServiceImpl.java`)

**实现方法**：
```java
@Override
public EvaluationSubmission selectByUserAndSemester(Long userId, String academicYear, Integer semester)
{
    EvaluationSubmission query = new EvaluationSubmission();
    query.setUserId(userId);
    query.setAcademicYear(academicYear);
    query.setSemester(semester);
    
    List<EvaluationSubmission> list = evaluationSubmissionMapper.selectEvaluationSubmissionList(query);
    
    if (list != null && !list.isEmpty()) {
        EvaluationSubmission submission = list.get(0);
        
        // 加载详情列表
        java.util.List<com.ruoyi.system.domain.EvaluationSubmissionDetail> details = 
            evaluationSubmissionDetailMapper.selectBySubmissionId(submission.getId());
        
        // 为每个详情加载附件
        if (details != null && !details.isEmpty()) {
            for (com.ruoyi.system.domain.EvaluationSubmissionDetail detail : details) {
                java.util.List<com.ruoyi.system.domain.EvaluationAttachment> attachments = 
                    evaluationAttachmentMapper.selectByDetailId(detail.getId());
                detail.setAttachments(attachments);
            }
        }
        
        submission.setDetails(details);
        
        return submission;
    }
    
    return null;
}
```

#### 3. Controller (`EvaluationSubmissionController.java`)

**新增接口**：
```java
/**
 * 查询学生在指定学年学期的提交记录
 */
@PreAuthorize("@ss.hasPermi('evaluation:submission:query')")
@GetMapping("/semester")
public AjaxResult getBySemester(@RequestParam String academicYear, @RequestParam Integer semester)
{
    Long userId = SecurityUtils.getUserId();
    EvaluationSubmission submission = evaluationSubmissionService.selectByUserAndSemester(userId, academicYear, semester);
    return success(submission);
}
```

**新增import**：
```java
import org.springframework.web.bind.annotation.RequestParam;
import com.ruoyi.common.utils.SecurityUtils;
```

---

### 前端修改

#### 1. API方法 (`submission.js`)

**新增方法**：
```javascript
// 查询学生在指定学年学期的提交记录
export function getSubmissionBySemester(academicYear, semester) {
  return request({
    url: '/evaluation/submission/semester',
    method: 'get',
    params: { academicYear, semester }
  })
}
```

#### 2. SubmissionForm组件 (`SubmissionForm.vue`)

**删除的内容**：
1. "保存草稿"按钮
2. `saving` 状态和 `autoSaveTimer` 定时器
3. watch中的自动保存监听
4. `checkAndAutoSaveDraft()` 方法
5. `autoSaveDraft()` 方法
6. `saveDraft()` 方法
7. `loadDraftFromLocalStorage()` 方法
8. `clearDraftFromLocalStorage()` 方法
9. 提交成功后清除草稿的代码

**新增的内容**：

**导入API**：
```javascript
import { getRuleTree, createSubmission, updateSubmission, getSubmissionDetail, getSubmissionBySemester } from '@/api/evaluation/submission'
```

**修改初始化逻辑**：
```javascript
async initializeData() {
  this.loading = true
  try {
    // 并行加载基础数据
    await Promise.all([
      this.generateAcademicYears(),
      this.loadClassOptions(),
      this.loadRuleOptions()
    ])

    // 如果是编辑或查看模式，加载填报数据
    if (this.recordId && (this.mode === 'edit' || this.mode === 'view')) {
      await this.loadSubmissionData()
    } else {
      // 新增模式，设置默认值
      this.setDefaultValues()
      // 尝试加载该学年学期的已有记录
      await this.loadExistingSubmission()
    }
  } catch (error) {
    console.error('初始化数据失败:', error)
    this.$message.error('初始化数据失败')
  } finally {
    this.loading = false
  }
},
```

**新增方法**：
```javascript
// 加载该学年学期的已有记录
async loadExistingSubmission() {
  try {
    console.log('[SubmissionForm] 尝试加载已有记录...', {
      academicYear: this.formData.academicYear,
      semester: this.formData.semester
    })
    
    const response = await getSubmissionBySemester(
      this.formData.academicYear,
      this.formData.semester
    )
    
    if (response.code === 200 && response.data) {
      const data = response.data
      
      console.log('[SubmissionForm] 找到已有记录，加载数据...', data)
      
      // 设置基本信息
      this.formData = {
        id: data.id,
        academicYear: data.academicYear,
        semester: data.semester,
        classId: data.classId,
        status: data.status,
        remark: data.remark || ''
      }

      // 设置submissionId（用于成绩截图上传）
      this.submissionId = data.id

      // 设置成果数据
      if (data.details && data.details.length > 0) {
        this.loadAchievementsFromDetails(data.details)
      }

      // 更新分数总览
      this.updateAllScores()
      
      this.$message.success('已加载您在本学期的填报记录，可以继续修改')
    } else {
      console.log('[SubmissionForm] 未找到已有记录，保持空白表单')
    }
  } catch (error) {
    console.error('[SubmissionForm] 加载已有记录失败:', error)
    // 不显示错误提示，保持空白表单
  }
},
```

---

## 用户体验

### 场景1：第一次填报
1. 用户打开填报页面
2. 系统查询数据库，未找到记录
3. 显示空白表单
4. 用户填写数据并提交

### 场景2：第二次填报（修改）
1. 用户打开填报页面
2. 系统查询数据库，找到已有记录
3. 自动加载上次提交的数据
4. 显示提示："已加载您在本学期的填报记录，可以继续修改"
5. 用户修改数据并提交
6. 后端执行"删除旧记录 + 插入新记录"

---

## 测试步骤

### 1. 重启后端服务
```bash
# 停止后端服务
# 重新启动后端服务
```

### 2. 刷新前端
```bash
Ctrl + F5  # 强制刷新，清除缓存
```

### 3. 测试第一次填报
1. 登录学生账号
2. 进入"综合测评填报"页面
3. 确认显示空白表单
4. 填写各维度成果
5. 点击"提交审核"
6. 确认提交成功

### 4. 测试第二次填报（修改）
1. 再次进入"综合测评填报"页面
2. 确认自动加载了上次提交的数据
3. 确认显示提示："已加载您在本学期的填报记录，可以继续修改"
4. 修改部分数据
5. 点击"提交审核"
6. 确认提交成功

### 5. 验证数据库
```sql
-- 查询学生的提交记录
SELECT * FROM evaluation_submission WHERE user_id = 1 AND academic_year = '2025-2026' AND semester = 1;

-- 查询详情记录
SELECT * FROM evaluation_submission_detail WHERE submission_id = ?;

-- 查询附件记录
SELECT * FROM evaluation_attachment WHERE detail_id = ?;
```

---

## 注意事项

1. **数据库唯一约束**：`uk_student_year_semester` 确保同一学生在同一学年学期只能有一条记录
2. **更新策略**：提交时会删除旧的详情和附件记录，然后插入新记录
3. **MinIO文件**：旧的附件文件不会被删除，成为"孤儿文件"（已记录在待优化清单中）
4. **权限控制**：接口需要 `evaluation:submission:query` 权限

---

## 相关文件

### 后端文件
- `ruoyi-system/src/main/java/com/ruoyi/system/service/IEvaluationSubmissionService.java`
- `ruoyi-system/src/main/java/com/ruoyi/system/service/impl/EvaluationSubmissionServiceImpl.java`
- `ruoyi-admin/src/main/java/com/ruoyi/web/controller/evaluation/EvaluationSubmissionController.java`

### 前端文件
- `ruoyi-ui/src/api/evaluation/submission.js`
- `ruoyi-ui/src/views/evaluation-submit/submission/SubmissionForm.vue`

---

## 优化建议

如果需要保留历史版本记录，可以考虑以下方案：
1. **软删除**：添加 `is_deleted` 字段
2. **版本控制**：添加 `version` 字段
3. **历史表**：创建独立的历史记录表

详见：`doc/待优化功能清单.md`

