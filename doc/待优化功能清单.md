# 待优化功能清单

## 优先级说明
- **P0**: 紧急，影响核心功能
- **P1**: 重要，影响用户体验
- **P2**: 一般，优化改进
- **P3**: 低优先级，可延后处理

---

## P3 - MinIO文件清理机制

### 问题描述
当学生多次提交综测表单时，旧的附件记录会从数据库中删除，但MinIO中的文件并未被删除，导致"孤儿文件"占用存储空间。

### 当前行为
```
学生第1次提交 → 上传附件A.pdf → MinIO存储 + 数据库记录
学生第2次提交 → 上传附件B.pdf → MinIO存储 + 数据库记录
                                → 数据库删除附件A的记录
                                → MinIO中A.pdf仍然存在 ❌
```

### 影响范围
- 存储空间浪费
- 长期累积可能导致存储成本增加
- 不影响核心功能

### 优化方案

#### 方案1：同步删除（推荐）
在删除附件记录前，先从MinIO删除对应的文件。

**实施步骤**：
1. 修改 `EvaluationSubmissionServiceImpl.syncDetailsAndAttachments()` 方法
2. 在执行 `deleteBySubmissionId()` 前，先查询旧的附件记录
3. 遍历旧附件，调用 MinIO 删除 API
4. 然后再删除数据库记录

**代码示例**：
```java
private void syncDetailsAndAttachments(Long submissionId, List<EvaluationSubmissionDetail> details, List<String> gradeScreenshotUrls) {
    if (submissionId == null) {
        return;
    }
    
    // 1. 查询旧的详情记录
    List<EvaluationSubmissionDetail> oldDetails = evaluationSubmissionDetailMapper.selectBySubmissionId(submissionId);
    
    // 2. 查询旧的附件记录
    List<EvaluationAttachment> oldAttachments = new ArrayList<>();
    for (EvaluationSubmissionDetail detail : oldDetails) {
        List<EvaluationAttachment> atts = evaluationAttachmentMapper.selectByDetailId(detail.getId());
        oldAttachments.addAll(atts);
    }
    
    // 3. 从MinIO删除旧文件
    for (EvaluationAttachment att : oldAttachments) {
        try {
            minioClient.removeObject(
                RemoveObjectArgs.builder()
                    .bucket(minioBucket)
                    .object(att.getFilePath())
                    .build()
            );
            logger.info("已从MinIO删除文件: {}", att.getFilePath());
        } catch (Exception e) {
            logger.error("删除MinIO文件失败: {}", att.getFilePath(), e);
            // 继续执行，不影响主流程
        }
    }
    
    // 4. 删除数据库记录（级联删除附件记录）
    evaluationSubmissionDetailMapper.deleteBySubmissionId(submissionId);
    
    // 5. 插入新的详情和附件
    // ... 现有逻辑
}
```

#### 方案2：定期清理脚本
创建定时任务，定期扫描并清理孤儿文件。

**实施步骤**：
1. 创建定时任务类 `MinioCleanupTask`
2. 扫描MinIO中的所有文件
3. 检查数据库中是否存在对应的附件记录
4. 删除不存在记录的文件

**优点**：
- 不影响现有业务逻辑
- 可以统一处理历史遗留问题

**缺点**：
- 需要额外的定时任务
- 清理不及时

#### 方案3：软删除
不物理删除文件，只标记为已删除。

**实施步骤**：
1. 在 `evaluation_attachment` 表添加 `is_deleted` 字段
2. 删除时只更新标记，不删除记录
3. 查询时过滤已删除的记录
4. 定期清理标记为已删除的文件

### 优先级
**P3 - 低优先级**

### 预计工时
- 方案1：2小时
- 方案2：4小时
- 方案3：6小时

### 备注
- 建议在系统负载较低时实施
- 需要先评估当前MinIO中孤儿文件的数量和大小
- 可以先实施方案2作为临时解决方案，再逐步迁移到方案1

---

## 其他待优化项

### P2 - 历史版本控制
**问题**：学生无法查看之前提交的版本
**方案**：实现版本控制机制，保留历史提交记录

### P2 - 附件预览优化
**问题**：部分文件类型无法预览
**方案**：集成文件预览服务（如Office文档、PDF等）

### P1 - 批量操作优化
**问题**：班委审核时需要逐个点击
**方案**：支持批量审核、批量下载附件

---

**创建时间**: 2025-11-11
**最后更新**: 2025-11-11

