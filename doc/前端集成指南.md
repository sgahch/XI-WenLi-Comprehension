# 学生批量导入功能 - 前端集成指南

## 概述

本文档提供学生批量导入功能的前端集成指南，包括API调用示例、Vue组件示例和常见问题解决方案。

## API接口说明

### 1. 下载导入模板

**接口地址**: `POST /evaluation/t_user_profile/importTemplate`

**请求方式**: POST

**请求参数**: 无

**响应**: Excel文件流

**前端调用示例**:

```javascript
// 使用axios
import { download } from '@/utils/request'

export function downloadTemplate() {
  return download('/evaluation/t_user_profile/importTemplate', {}, '学生批量导入模板.xlsx')
}
```

### 2. 批量导入学生

**接口地址**: `POST /evaluation/t_user_profile/importStudents`

**请求方式**: POST (multipart/form-data)

**请求参数**:

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| file | File | 是 | Excel文件 |
| updateSupport | boolean | 否 | 是否更新已存在数据，默认false |

**响应示例**:

成功:
```json
{
  "code": 200,
  "msg": "恭喜您，数据已全部导入成功！共 5 条，数据如下：\n1、学号 2507240101 导入成功\n2、学号 2507240102 导入成功\n3、学号 2507240201 导入成功\n4、学号 2507230101 导入成功\n5、学号 2507230102 导入成功"
}
```

失败:
```json
{
  "code": 500,
  "msg": "很抱歉，导入失败！共 1 条数据格式不正确，错误如下：\n1、学号  导入失败：学号不能为空"
}
```

**前端调用示例**:

```javascript
// api/evaluation/userProfile.js
import request from '@/utils/request'

// 批量导入学生
export function importStudents(data) {
  return request({
    url: '/evaluation/t_user_profile/importStudents',
    method: 'post',
    data: data
  })
}
```

## Vue组件示例

### 完整的导入组件

```vue
<template>
  <div class="student-import">
    <!-- 导入按钮 -->
    <el-row :gutter="10" class="mb8">
      <el-col :span="1.5">
        <el-button
          type="primary"
          plain
          icon="el-icon-upload"
          size="mini"
          @click="handleImport"
          v-hasPermi="['evaluation:t_user_profile:import']"
        >批量导入</el-button>
      </el-col>
    </el-row>

    <!-- 导入对话框 -->
    <el-dialog 
      title="学生批量导入" 
      :visible.sync="importDialog.open" 
      width="500px" 
      append-to-body
    >
      <el-form ref="importForm" :model="importDialog" label-width="120px">
        <el-form-item label="Excel文件">
          <el-upload
            ref="upload"
            :limit="1"
            accept=".xlsx, .xls"
            :headers="importDialog.headers"
            :action="importDialog.url + '?updateSupport=' + importDialog.updateSupport"
            :disabled="importDialog.isUploading"
            :on-progress="handleFileUploadProgress"
            :on-success="handleFileSuccess"
            :on-error="handleFileError"
            :auto-upload="false"
            drag
          >
            <i class="el-icon-upload"></i>
            <div class="el-upload__text">将文件拖到此处，或<em>点击上传</em></div>
            <div class="el-upload__tip text-center" slot="tip">
              <div class="el-upload__tip" slot="tip">
                <el-checkbox v-model="importDialog.updateSupport" />是否更新已存在的学生数据
              </div>
              <span>仅允许导入xls、xlsx格式文件。</span>
              <el-link type="primary" :underline="false" style="font-size:12px;vertical-align: baseline;" @click="downloadTemplate">下载模板</el-link>
            </div>
          </el-upload>
        </el-form-item>
      </el-form>
      <div slot="footer" class="dialog-footer">
        <el-button type="primary" @click="submitFileForm">确 定</el-button>
        <el-button @click="importDialog.open = false">取 消</el-button>
      </div>
    </el-dialog>
  </div>
</template>

<script>
import { importStudents, downloadTemplate } from "@/api/evaluation/userProfile";
import { getToken } from "@/utils/auth";

export default {
  name: "StudentImport",
  data() {
    return {
      // 导入对话框
      importDialog: {
        // 是否显示弹出层
        open: false,
        // 弹出层标题
        title: "",
        // 是否禁用上传
        isUploading: false,
        // 是否更新已经存在的用户数据
        updateSupport: false,
        // 设置上传的请求头部
        headers: { Authorization: "Bearer " + getToken() },
        // 上传的地址
        url: process.env.VUE_APP_BASE_API + "/evaluation/t_user_profile/importStudents"
      }
    };
  },
  methods: {
    /** 打开导入对话框 */
    handleImport() {
      this.importDialog.open = true;
      this.importDialog.updateSupport = false;
    },
    
    /** 下载模板 */
    downloadTemplate() {
      downloadTemplate().then(response => {
        this.$modal.msgSuccess("模板下载成功");
      });
    },
    
    /** 提交上传文件 */
    submitFileForm() {
      this.$refs.upload.submit();
    },
    
    /** 文件上传中处理 */
    handleFileUploadProgress(event, file, fileList) {
      this.importDialog.isUploading = true;
    },
    
    /** 文件上传成功处理 */
    handleFileSuccess(response, file, fileList) {
      this.importDialog.open = false;
      this.importDialog.isUploading = false;
      this.$refs.upload.clearFiles();
      
      // 显示导入结果
      this.$alert(
        "<div style='overflow: auto;overflow-x: hidden;max-height: 70vh;padding: 10px 20px 0;'>" + 
        response.msg.replace(/\n/g, '<br/>') + 
        "</div>", 
        "导入结果", 
        { 
          dangerouslyUseHTMLString: true,
          confirmButtonText: '确定',
          callback: action => {
            // 刷新列表
            this.$emit('refresh');
          }
        }
      );
    },
    
    /** 文件上传失败处理 */
    handleFileError(err, file, fileList) {
      this.importDialog.isUploading = false;
      this.$modal.msgError("上传失败，请重试");
    }
  }
};
</script>

<style scoped>
.student-import {
  margin-bottom: 10px;
}
</style>
```

### 在页面中使用导入组件

```vue
<template>
  <div class="app-container">
    <!-- 导入组件 -->
    <student-import @refresh="getList" />
    
    <!-- 学生列表 -->
    <el-table v-loading="loading" :data="studentList">
      <!-- 表格列定义 -->
    </el-table>
  </div>
</template>

<script>
import StudentImport from './components/StudentImport'

export default {
  name: "UserProfile",
  components: {
    StudentImport
  },
  data() {
    return {
      loading: false,
      studentList: []
    }
  },
  methods: {
    /** 查询学生列表 */
    getList() {
      this.loading = true;
      // 调用API获取列表
      // ...
      this.loading = false;
    }
  },
  created() {
    this.getList();
  }
}
</script>
```

## API工具函数

创建 `src/api/evaluation/userProfile.js`:

```javascript
import request from '@/utils/request'

// 查询学生档案列表
export function listUserProfile(query) {
  return request({
    url: '/evaluation/t_user_profile/list',
    method: 'get',
    params: query
  })
}

// 查询学生档案详细
export function getUserProfile(id) {
  return request({
    url: '/evaluation/t_user_profile/' + id,
    method: 'get'
  })
}

// 新增学生档案
export function addUserProfile(data) {
  return request({
    url: '/evaluation/t_user_profile',
    method: 'post',
    data: data
  })
}

// 修改学生档案
export function updateUserProfile(data) {
  return request({
    url: '/evaluation/t_user_profile',
    method: 'put',
    data: data
  })
}

// 删除学生档案
export function delUserProfile(id) {
  return request({
    url: '/evaluation/t_user_profile/' + id,
    method: 'delete'
  })
}

// 下载导入模板
export function downloadTemplate() {
  return request({
    url: '/evaluation/t_user_profile/importTemplate',
    method: 'post',
    responseType: 'blob'
  })
}

// 批量导入学生
export function importStudents(data) {
  return request({
    url: '/evaluation/t_user_profile/importStudents',
    method: 'post',
    headers: { 'Content-Type': 'multipart/form-data' },
    data: data
  })
}

// 导出学生档案
export function exportUserProfile(query) {
  return request({
    url: '/evaluation/t_user_profile/export',
    method: 'post',
    params: query,
    responseType: 'blob'
  })
}
```

## 工具函数 - 文件下载

如果项目中没有 `download` 工具函数，可以添加到 `src/utils/request.js`:

```javascript
// 通用下载方法
export function download(url, params, filename) {
  return service.post(url, params, {
    transformRequest: [(params) => { return tansParams(params) }],
    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
    responseType: 'blob'
  }).then(async (data) => {
    const isLogin = await blobValidate(data);
    if (isLogin) {
      const blob = new Blob([data])
      saveAs(blob, filename)
    } else {
      const resText = await data.text();
      const rspObj = JSON.parse(resText);
      const errMsg = errorCode[rspObj.code] || rspObj.msg || errorCode['default']
      Message.error(errMsg);
    }
  }).catch((r) => {
    console.error(r)
    Message.error('下载文件出现错误，请联系管理员！')
  })
}
```

## 权限配置

### 1. 后端权限配置

在菜单管理中添加权限标识:
- 权限字符: `evaluation:t_user_profile:import`
- 权限名称: 学生批量导入

### 2. 前端权限指令

使用 `v-hasPermi` 指令控制按钮显示:

```vue
<el-button
  type="primary"
  icon="el-icon-upload"
  @click="handleImport"
  v-hasPermi="['evaluation:t_user_profile:import']"
>批量导入</el-button>
```

## 常见问题

### 1. 文件上传失败

**问题**: 上传文件时提示"上传失败"

**解决方案**:
- 检查文件大小是否超过限制（默认10MB）
- 检查文件格式是否为.xlsx或.xls
- 检查后端接口是否正常
- 检查token是否有效

### 2. 导入后数据未刷新

**问题**: 导入成功后列表未更新

**解决方案**:
在导入成功回调中调用列表刷新方法:

```javascript
handleFileSuccess(response, file, fileList) {
  // ...
  this.$emit('refresh'); // 触发父组件刷新
  // 或直接调用
  this.getList();
}
```

### 3. 导入结果显示不全

**问题**: 导入结果消息过长，显示不完整

**解决方案**:
使用 `el-dialog` 或 `el-alert` 并设置最大高度:

```javascript
this.$alert(
  "<div style='overflow: auto; max-height: 70vh;'>" + 
  response.msg.replace(/\n/g, '<br/>') + 
  "</div>", 
  "导入结果", 
  { dangerouslyUseHTMLString: true }
);
```

### 4. 跨域问题

**问题**: 开发环境下文件上传跨域

**解决方案**:
在 `vue.config.js` 中配置代理:

```javascript
module.exports = {
  devServer: {
    proxy: {
      [process.env.VUE_APP_BASE_API]: {
        target: 'http://localhost:8080',
        changeOrigin: true,
        pathRewrite: {
          ['^' + process.env.VUE_APP_BASE_API]: ''
        }
      }
    }
  }
}
```

## 测试步骤

1. **下载模板测试**
   - 点击"下载模板"链接
   - 验证下载的Excel文件格式正确

2. **正常导入测试**
   - 填写模板数据
   - 上传文件
   - 验证导入成功提示
   - 刷新列表验证数据

3. **更新模式测试**
   - 勾选"是否更新已存在的学生数据"
   - 上传相同学号的数据
   - 验证数据已更新

4. **错误处理测试**
   - 上传空文件
   - 上传错误格式文件
   - 上传包含错误数据的文件
   - 验证错误提示正确

## 性能优化建议

1. **大文件上传**
   - 增加上传超时时间
   - 显示上传进度条
   - 考虑分批导入

2. **用户体验**
   - 上传过程中禁用按钮
   - 显示加载动画
   - 提供详细的错误提示

3. **数据验证**
   - 前端预验证文件格式
   - 限制文件大小
   - 提示必填字段

## 示例截图说明

### 导入按钮位置
建议放在列表页面的操作栏，与"新增"、"导出"等按钮并列。

### 导入对话框
- 标题: "学生批量导入"
- 内容: 文件上传区域 + 更新选项 + 模板下载链接
- 按钮: "确定"、"取消"

### 导入结果展示
使用 `el-alert` 组件展示导入结果，支持滚动查看详细信息。

## 附录

### Excel模板字段说明

| 列 | 字段名 | 说明 | 必填 | 示例 |
|----|--------|------|------|------|
| A | 专业名称 | 学生所属专业 | 是 | 软件工程 |
| B | 班级 | 学生所属班级 | 是 | 2401 |
| C | 姓名 | 学生姓名 | 是 | 张三 |
| D | 学号（或教职工号） | 登录账号 | 是 | 2507240101 |
| E | 手机号码 | 联系电话 | 否 | 13800138000 |
| F | 用户性别 | 男/女/未知 | 否 | 男 |
| G | 身份 | 学生/班委/辅导员 | 是 | 学生 |
| H | 邮箱 | 电子邮箱 | 否 | zhangsan@example.com |
| I | 政治面貌 | 群众/团员/党员 | 否 | 团员 |
| J | 入学日期 | YYYY-MM-DD格式 | 否 | 2024-09-01 |

### 默认配置

- 初始密码: 123456（可在系统配置中修改）
- 学生角色ID: 100
- 班委角色ID: 100, 101
- 辅导员角色ID: 102

