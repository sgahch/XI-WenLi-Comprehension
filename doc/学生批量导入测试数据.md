# 学生批量导入功能 - 完整说明文档

## 功能概述

学生批量导入功能允许管理员通过导入Excel文件快速创建学生账户。系统会自动：
- 创建用户账号（sys_user表）
- 分配角色（sys_user_role表）
- 创建学生档案（t_user_profile表，仅学生和班委）
- 智能匹配部门（根据专业+班级）
- 自动推断年级（从学号）

## 快速开始

### 1. 准备测试环境

执行SQL脚本创建必要的部门结构：
```bash
mysql -u root -p your_database < doc/prepare_test_environment.sql
```

### 2. 生成测试Excel文件

```bash
python doc/generate_test_excel.py
```

这将生成4个测试文件：
- `学生批量导入测试数据_正常.xlsx` - 正常导入测试
- `学生批量导入测试数据_验证失败.xlsx` - 数据验证测试
- `学生批量导入测试数据_部门不存在.xlsx` - 部门匹配测试
- `学生批量导入测试数据_混合.xlsx` - 混合场景测试

### 3. 测试导入功能

使用Postman导入测试集合：
```
doc/学生批量导入API测试.postman_collection.json
```

或直接调用API：
```bash
curl -X POST "http://localhost:8080/evaluation/t_user_profile/importStudents" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -F "file=@学生批量导入测试数据_正常.xlsx" \
  -F "updateSupport=false"
```

---

## 测试Excel数据示例

### 测试场景1：正常导入（新增学生）

| 专业名称 | 班级 | 姓名 | 学号（或教职工号） | 手机号码 | 用户性别 | 身份（学生、班委、辅导员） | 邮箱 | 政治面貌 | 入学日期 |
|---------|------|------|-------------------|----------|---------|------------------------|------|---------|----------|
| 软件工程 | 2401 | 张三 | 2507240101 | 13800138001 | 男 | 学生 | zhangsan@example.com | 团员 | 2024-09-01 |
| 软件工程 | 2401 | 李四 | 2507240102 | 13800138002 | 女 | 班委 | lisi@example.com | 党员 | 2024-09-01 |
| 软件工程 | 2402 | 王五 | 2507240201 | 13800138003 | 男 | 学生 | wangwu@example.com | 群众 | 2024-09-01 |
| 计算机科学与技术 | 2401 | 赵六 | 2507230101 | 13800138004 | 女 | 学生 | zhaoliu@example.com | 团员 | 2024-09-01 |
| 计算机科学与技术 | 2401 | 孙七 | 2507230102 | 13800138005 | 男 | 班委 | sunqi@example.com | 党员 | 2024-09-01 |

### 测试场景2：包含辅导员

| 专业名称 | 班级 | 姓名 | 学号（或教职工号） | 手机号码 | 用户性别 | 身份（学生、班委、辅导员） | 邮箱 | 政治面貌 | 入学日期 |
|---------|------|------|-------------------|----------|---------|------------------------|------|---------|----------|
| 软件工程 | 2401 | 周老师 | T20240001 | 13900139001 | 女 | 辅导员 | zhoulaoshi@example.com | 党员 | 2024-09-01 |

### 测试场景3：数据验证测试（应该失败）

| 专业名称 | 班级 | 姓名 | 学号（或教职工号） | 手机号码 | 用户性别 | 身份（学生、班委、辅导员） | 邮箱 | 政治面貌 | 入学日期 |
|---------|------|------|-------------------|----------|---------|------------------------|------|---------|----------|
| 软件工程 | 2401 | 测试1 |  | 13800138010 | 男 | 学生 | test1@example.com | 团员 | 2024-09-01 |
| 软件工程 |  | 测试2 | 2507240999 | 13800138011 | 女 | 学生 | test2@example.com | 团员 | 2024-09-01 |
|  | 2401 | 测试3 | 2507240998 | 13800138012 | 男 | 学生 | test3@example.com | 团员 | 2024-09-01 |
| 软件工程 | 2401 | 测试4 | 2507240997 | 13800138013 | 女 | 教师 | test4@example.com | 党员 | 2024-09-01 |

**预期结果：**
- 测试1：失败 - 学号不能为空
- 测试2：失败 - 班级不能为空
- 测试3：失败 - 专业名称不能为空
- 测试4：失败 - 身份[教师]不合法，只能是：学生、班委、辅导员

### 测试场景4：部门不存在测试（应该失败）

| 专业名称 | 班级 | 姓名 | 学号（或教职工号） | 手机号码 | 用户性别 | 身份（学生、班委、辅导员） | 邮箱 | 政治面貌 | 入学日期 |
|---------|------|------|-------------------|----------|---------|------------------------|------|---------|----------|
| 不存在的专业 | 2401 | 测试5 | 2507249999 | 13800138014 | 男 | 学生 | test5@example.com | 团员 | 2024-09-01 |

**预期结果：**
- 失败 - 未找到专业[不存在的专业]班级[2401]对应的部门

## 测试步骤

### 1. 准备测试环境

确保数据库中已存在以下部门结构：
```
信息学院 (dept_id=101)
  ├─ 软件工程 (dept_id=103)
  │   ├─ 2401班 (dept_id=500)
  │   └─ 2402班 (dept_id=501)
  └─ 计算机科学与技术 (dept_id=104)
      └─ 2401班 (dept_id=502)
```

### 2. 下载导入模板

**接口：** `POST /evaluation/t_user_profile/importTemplate`

**请求方式：** POST

**响应：** 下载Excel模板文件

### 3. 填写测试数据

将上述测试数据填入下载的模板中。

### 4. 执行导入

**接口：** `POST /evaluation/t_user_profile/importStudents`

**请求参数：**
- `file`: MultipartFile - Excel文件
- `updateSupport`: boolean - 是否更新已存在的数据（可选，默认false）

**请求示例（使用Postman）：**
```
POST http://localhost:8080/evaluation/t_user_profile/importStudents?updateSupport=false
Content-Type: multipart/form-data

file: [选择Excel文件]
```

**成功响应示例：**
```json
{
  "msg": "恭喜您，数据已全部导入成功！共 5 条，数据如下：\n1、学号 2507240101 导入成功\n2、学号 2507240102 导入成功\n3、学号 2507240201 导入成功\n4、学号 2507230101 导入成功\n5、学号 2507230102 导入成功",
  "code": 200
}
```

**失败响应示例：**
```json
{
  "msg": "很抱歉，导入失败！共 1 条数据格式不正确，错误如下：\n1、学号  导入失败：学号不能为空",
  "code": 500
}
```

### 5. 验证导入结果

#### 5.1 检查sys_user表
```sql
SELECT user_id, user_name, nick_name, dept_id, phonenumber, email, sex, status
FROM sys_user
WHERE user_name IN ('2507240101', '2507240102', '2507240201', '2507230101', '2507230102');
```

**预期结果：**
- 5条用户记录
- user_name为学号
- nick_name为姓名
- dept_id对应班级部门ID
- 密码已加密（BCrypt）
- status=0（正常状态）

#### 5.2 检查sys_user_role表
```sql
SELECT ur.user_id, u.user_name, ur.role_id
FROM sys_user_role ur
JOIN sys_user u ON ur.user_id = u.user_id
WHERE u.user_name IN ('2507240101', '2507240102', '2507240201', '2507230101', '2507230102')
ORDER BY u.user_name, ur.role_id;
```

**预期结果：**
- 2507240101: role_id=100（学生）
- 2507240102: role_id=100,101（学生+班委）
- 2507240201: role_id=100（学生）
- 2507230101: role_id=100（学生）
- 2507230102: role_id=100,101（学生+班委）

#### 5.3 检查t_user_profile表
```sql
SELECT p.id, p.user_id, p.student_id, p.college, p.major, p.grade, p.class_name, 
       p.dept_id, p.political_status, p.enrollment_date, p.status
FROM t_user_profile p
JOIN sys_user u ON p.user_id = u.user_id
WHERE u.user_name IN ('2507240101', '2507240102', '2507240201', '2507230101', '2507230102')
ORDER BY p.student_id;
```

**预期结果：**
- 5条学生档案记录
- student_id与学号一致
- college、major、class_name从部门树解析
- grade从学号推断（如：2025）
- political_status、enrollment_date正确填充
- status=1（启用状态）

### 6. 测试更新模式

使用相同的Excel文件，修改部分数据（如手机号、邮箱），然后：

**请求：**
```
POST http://localhost:8080/evaluation/t_user_profile/importStudents?updateSupport=true
```

**验证：**
- 用户信息已更新
- 学生档案信息已更新
- 不会创建重复记录

## 常见问题排查

### 问题1：导入失败 - 未找到部门

**原因：** 数据库中不存在对应的专业或班级部门

**解决：**
1. 检查sys_dept表中是否存在对应的部门
2. 确保部门名称与Excel中的专业名称、班级名称匹配
3. 确保部门状态为正常（status=0）

### 问题2：导入失败 - 身份不合法

**原因：** 身份列填写了非法值

**解决：** 确保身份列只填写：学生、班委、辅导员

### 问题3：导入成功但无法登录

**原因：** 密码未正确设置

**解决：**
1. 检查sys_config表中的sys.user.initPassword配置
2. 默认密码为123456
3. 使用学号+密码登录

### 问题4：辅导员没有创建学生档案

**原因：** 这是正常的，辅导员不需要学生档案

**说明：** 只有身份为"学生"或"班委"的用户才会创建t_user_profile记录

## 性能测试

### 批量导入性能

- **小批量（1-100条）：** 预计 < 5秒
- **中批量（100-500条）：** 预计 < 30秒
- **大批量（500-1000条）：** 预计 < 60秒

**注意：** 实际性能取决于服务器配置和数据库性能

## 安全性测试

### 权限验证

确保只有拥有 `evaluation:t_user_profile:import` 权限的用户才能执行导入操作。

**测试步骤：**
1. 使用无权限用户登录
2. 尝试调用导入接口
3. 应返回403 Forbidden

### SQL注入测试

尝试在Excel中填入特殊字符：
- `'; DROP TABLE sys_user; --`
- `<script>alert('xss')</script>`

**预期结果：** 系统应正常处理，不会执行恶意代码

## 回归测试清单

- [ ] 新增学生导入成功
- [ ] 新增班委导入成功（双角色）
- [ ] 新增辅导员导入成功（无学生档案）
- [ ] 更新模式正常工作
- [ ] 必填字段验证生效
- [ ] 身份合法性验证生效
- [ ] 部门匹配逻辑正确
- [ ] 年级自动推断正确
- [ ] 性别转换正确
- [ ] 事务回滚正常（部分失败时）
- [ ] 权限控制生效
- [ ] 操作日志记录正确

