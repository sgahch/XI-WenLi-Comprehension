# 综测审核流程测试指南

## 📋 文档概述

**创建时间**: 2025-11-03  
**版本**: v1.0  
**目的**: 指导测试人员完成审核流程的完整测试

---

## 🎯 测试目标

验证以下功能：
1. ✅ 状态自动流转逻辑
2. ✅ 角色权限校验
3. ✅ 审核日志记录
4. ✅ 批量审核功能
5. ✅ 异常情况处理

---

## 👥 测试账号准备

### 需要准备的测试账号

| 角色 | 用户名 | 角色ID | 权限 |
|------|--------|--------|------|
| 学生 | student01 | 100 | 创建和提交填报 |
| 班委 | monitor01 | 101 | 审核status=1的记录 |
| 辅导员 | counselor01 | 102 | 审核status=2的记录 |
| 管理员 | admin | 1 | 审核任何状态的记录 |

### 创建测试账号SQL

```sql
-- 如果还没有测试账号，可以执行以下SQL创建

-- 1. 创建学生账号
INSERT INTO sys_user (user_id, dept_id, user_name, nick_name, user_type, email, phonenumber, sex, avatar, password, status, del_flag, login_ip, login_date, create_by, create_time, remark)
VALUES (100, 103, 'student01', '测试学生01', '00', 'student01@test.com', '13800000001', '0', '', '$2a$10$7JB720yubVSZvUI0rEqK/.VqGOZTH.ulu33dHOiBE/T/V/QjLeb6a', '0', '0', '', NOW(), 'admin', NOW(), '测试学生账号');

INSERT INTO sys_user_role (user_id, role_id) VALUES (100, 100);

-- 2. 创建班委账号
INSERT INTO sys_user (user_id, dept_id, user_name, nick_name, user_type, email, phonenumber, sex, avatar, password, status, del_flag, login_ip, login_date, create_by, create_time, remark)
VALUES (101, 103, 'monitor01', '测试班委01', '00', 'monitor01@test.com', '13800000002', '0', '', '$2a$10$7JB720yubVSZvUI0rEqK/.VqGOZTH.ulu33dHOiBE/T/V/QjLeb6a', '0', '0', '', NOW(), 'admin', NOW(), '测试班委账号');

INSERT INTO sys_user_role (user_id, role_id) VALUES (101, 101);

-- 3. 创建辅导员账号
INSERT INTO sys_user (user_id, dept_id, user_name, nick_name, user_type, email, phonenumber, sex, avatar, password, status, del_flag, login_ip, login_date, create_by, create_time, remark)
VALUES (102, 103, 'counselor01', '测试辅导员01', '00', 'counselor01@test.com', '13800000003', '0', '', '$2a$10$7JB720yubVSZvUI0rEqK/.VqGOZTH.ulu33dHOiBE/T/V/QjLeb6a', '0', '0', '', NOW(), 'admin', NOW(), '测试辅导员账号');

INSERT INTO sys_user_role (user_id, role_id) VALUES (102, 102);

-- 注意：所有测试账号的默认密码都是 admin123
```

---

## 🧪 测试用例

### 测试用例1: 正常审核流程（通过）

**目的**: 验证从提交到最终通过的完整流程

**步骤**:

1. **学生提交填报**
   - 登录学生账号 (student01/admin123)
   - 进入"我的填报"页面
   - 创建新的填报记录
   - 填写必要信息
   - 点击"提交审核"
   - **预期结果**: 状态变为"待班委审核"(status=1)

2. **班委审核通过**
   - 登录班委账号 (monitor01/admin123)
   - 进入"班委审核"页面
   - 找到刚才提交的记录
   - 点击"审核通过"
   - 填写审核意见（可选）
   - 确认审核
   - **预期结果**: 
     - 状态变为"待辅导员审核"(status=2)
     - 审核日志中记录了班委的审核操作
     - 返回结果包含状态流转描述

3. **辅导员审核通过**
   - 登录辅导员账号 (counselor01/admin123)
   - 进入"填报审核"页面
   - 找到待审核的记录
   - 点击"审核通过"
   - 填写审核意见（可选）
   - 确认审核
   - **预期结果**: 
     - 状态变为"已通过"(status=3)
     - 审核日志中记录了辅导员的审核操作
     - 学生可以在"填报历史"中看到最终结果

---

### 测试用例2: 班委驳回流程

**目的**: 验证班委驳回后的流程

**步骤**:

1. **学生提交填报**
   - 同测试用例1步骤1
   - **预期结果**: 状态变为"待班委审核"(status=1)

2. **班委审核驳回**
   - 登录班委账号
   - 进入"班委审核"页面
   - 找到待审核的记录
   - 点击"审核驳回"
   - **必须填写**驳回原因
   - 确认审核
   - **预期结果**: 
     - 状态变为"已驳回"(status=4)
     - 审核日志中记录了驳回原因

3. **学生修改后重新提交**
   - 登录学生账号
   - 进入"我的填报"页面
   - 找到被驳回的记录
   - 修改内容
   - 重新提交
   - **预期结果**: 状态重新变为"待班委审核"(status=1)

---

### 测试用例3: 辅导员驳回流程

**目的**: 验证辅导员驳回后的流程

**步骤**:

1. **学生提交 + 班委通过**
   - 完成测试用例1的步骤1和步骤2
   - **预期结果**: 状态变为"待辅导员审核"(status=2)

2. **辅导员审核驳回**
   - 登录辅导员账号
   - 进入"填报审核"页面
   - 找到待审核的记录
   - 点击"审核驳回"
   - **必须填写**驳回原因
   - 确认审核
   - **预期结果**: 
     - 状态变为"已驳回"(status=4)
     - 审核日志中记录了驳回原因

3. **学生修改后重新提交**
   - 同测试用例2步骤3

---

### 测试用例4: 权限校验测试

**目的**: 验证角色权限控制是否生效

**测试4.1: 班委不能审核status=2的记录**

1. 创建一条status=2的记录（通过管理员直接修改数据库）
   ```sql
   UPDATE evaluation_submission SET status = 2 WHERE id = <某个ID>;
   ```

2. 登录班委账号
3. 尝试审核这条记录
4. **预期结果**: 
   - 前端：记录不在班委的审核列表中（因为筛选条件status=1）
   - 后端：如果强制调用API，应返回错误"您无权审核此记录"

**测试4.2: 辅导员不能审核status=1的记录**

1. 创建一条status=1的记录
2. 登录辅导员账号
3. 尝试审核这条记录
4. **预期结果**: 
   - 前端：记录不在辅导员的审核列表中（因为筛选条件status=2）
   - 后端：如果强制调用API，应返回错误"您无权审核此记录"

**测试4.3: 管理员可以审核任何状态的记录**

1. 创建多条不同状态的记录
2. 登录管理员账号
3. 尝试审核这些记录
4. **预期结果**: 所有审核操作都应成功

---

### 测试用例5: 批量审核测试

**目的**: 验证批量审核功能

**步骤**:

1. **准备多条待审核记录**
   - 使用学生账号创建并提交3条填报记录
   - **预期结果**: 3条记录都是status=1

2. **班委批量审核通过**
   - 登录班委账号
   - 进入"班委审核"页面
   - 勾选这3条记录
   - 点击"批量审核通过"
   - 填写统一的审核意见
   - 确认审核
   - **预期结果**: 
     - 3条记录都变为status=2
     - 返回结果显示：成功3条，失败0条
     - 每条记录都有审核日志

3. **辅导员批量审核（部分成功）**
   - 手动修改其中1条记录的状态为status=1（模拟异常情况）
   - 登录辅导员账号
   - 勾选这3条记录
   - 点击"批量审核通过"
   - **预期结果**: 
     - 2条status=2的记录审核成功，变为status=3
     - 1条status=1的记录审核失败，返回权限错误
     - 返回结果显示：成功2条，失败1条

---

### 测试用例6: 异常情况测试

**测试6.1: 重复审核**

1. 审核一条记录使其变为status=3
2. 尝试再次审核这条记录
3. **预期结果**: 返回错误"当前状态不允许审核通过操作"

**测试6.2: 无效的操作类型**

1. 使用API工具（如Postman）发送审核请求
2. 将operation设置为无效值（如"INVALID"）
3. **预期结果**: 返回错误"无效的审核操作类型"

**测试6.3: 记录不存在**

1. 使用API工具发送审核请求
2. 将submissionId设置为不存在的ID
3. **预期结果**: 返回错误"填报记录不存在"

---

## 📊 测试检查清单

### 功能测试

- [ ] 学生可以提交填报（status 0→1）
- [ ] 班委可以审核通过（status 1→2）
- [ ] 班委可以审核驳回（status 1→4）
- [ ] 辅导员可以审核通过（status 2→3）
- [ ] 辅导员可以审核驳回（status 2→4）
- [ ] 学生可以重新提交被驳回的记录（status 4→1）
- [ ] 批量审核功能正常
- [ ] 审核日志正确记录

### 权限测试

- [ ] 班委只能审核status=1的记录
- [ ] 辅导员只能审核status=2的记录
- [ ] 管理员可以审核任何状态的记录
- [ ] 学生不能审核任何记录

### 异常测试

- [ ] 重复审核被正确拒绝
- [ ] 无效操作类型被正确拒绝
- [ ] 不存在的记录被正确处理
- [ ] 批量审核中的失败项被正确记录

---

## 🐛 常见问题排查

### 问题1: 审核后状态没有变化

**可能原因**:
- 数据库事务未提交
- 缓存未刷新

**排查方法**:
```sql
-- 直接查询数据库
SELECT id, student_id, status, audit_time, audit_by, audit_comment 
FROM evaluation_submission 
WHERE id = <记录ID>;

-- 查询审核日志
SELECT * FROM evaluation_audit_log 
WHERE submission_id = <记录ID> 
ORDER BY audit_time DESC;
```

### 问题2: 权限校验不生效

**可能原因**:
- 用户角色配置错误
- 权限注解未生效

**排查方法**:
```sql
-- 检查用户角色
SELECT u.user_id, u.user_name, r.role_id, r.role_name
FROM sys_user u
LEFT JOIN sys_user_role ur ON u.user_id = ur.user_id
LEFT JOIN sys_role r ON ur.role_id = r.role_id
WHERE u.user_name = '<用户名>';
```

### 问题3: 批量审核全部失败

**可能原因**:
- 请求参数格式错误
- 所有记录都不满足审核条件

**排查方法**:
- 查看后端日志
- 使用浏览器开发者工具查看网络请求
- 检查返回的failList中的错误信息

---

## 📝 测试报告模板

```
# 审核流程测试报告

## 测试信息
- 测试人员: [姓名]
- 测试时间: [日期]
- 测试环境: [开发/测试/生产]

## 测试结果汇总
- 总用例数: 6
- 通过数: [X]
- 失败数: [X]
- 通过率: [X%]

## 详细测试结果
| 用例编号 | 用例名称 | 测试结果 | 备注 |
|---------|---------|---------|------|
| TC1 | 正常审核流程（通过） | ✅/❌ | |
| TC2 | 班委驳回流程 | ✅/❌ | |
| TC3 | 辅导员驳回流程 | ✅/❌ | |
| TC4 | 权限校验测试 | ✅/❌ | |
| TC5 | 批量审核测试 | ✅/❌ | |
| TC6 | 异常情况测试 | ✅/❌ | |

## 发现的问题
1. [问题描述]
   - 严重程度: [高/中/低]
   - 复现步骤: [步骤]
   - 预期结果: [描述]
   - 实际结果: [描述]

## 测试结论
[通过/不通过]

## 建议
[改进建议]
```

---

**文档结束**

