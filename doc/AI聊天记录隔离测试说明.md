# AI聊天记录隔离测试说明

## 测试目标
验证AI智能助手的对话记录能够根据用户身份进行隔离，确保不同用户之间的聊天记录互不干扰。

## 实现原理

### 1. 业务ID生成规则
- **格式**: `用户ID_用户姓名_用户部门`
- **示例**: `100_胡淇_班委部门`、`1_admin_若依科技`

### 2. Redis存储方案
- **键格式**: `ai_chat:用户ID_用户姓名_用户部门`
- **值类型**: JSON格式的聊天历史记录对象
- **过期时间**: 3天（259200秒）

### 3. 数据结构
```json
{
  "businessId": "100_胡淇_班委部门",
  "userId": 100,
  "userName": "胡淇",
  "deptName": "班委部门",
  "messages": [
    {
      "timestamp": "2024-01-15 10:30:00",
      "type": "user",
      "content": "你好"
    },
    {
      "timestamp": "2024-01-15 10:30:05",
      "type": "ai",
      "content": "您好！有什么可以帮助您的吗？"
    }
  ],
  "createTime": "2024-01-15 10:30:00",
  "updateTime": "2024-01-15 10:30:05"
}
```

## 测试步骤

### 步骤1：准备测试用户
确保系统中有至少两个不同的用户账号：
- 用户A：胡淇（ID: 100，部门：班委部门）
- 用户B：admin（ID: 1，部门：若依科技）

### 步骤2：用户A聊天测试
1. 使用胡淇账号登录系统
2. 打开AI智能助手
3. 发送消息："我是胡淇，这是我的第一条消息"
4. 等待AI回复
5. 再发送消息："请记住我是班委部门的胡淇"
6. 记录聊天内容

### 步骤3：用户B聊天测试
1. 退出胡淇账号，使用admin账号登录
2. 打开AI智能助手
3. 检查是否能看到胡淇的聊天记录（应该看不到）
4. 发送消息："我是admin管理员，这是我的消息"
5. 等待AI回复
6. 发送消息："我来自若依科技"

### 步骤4：验证隔离效果
1. 切换回胡淇账号
2. 检查聊天记录是否还在（应该保留胡淇的聊天记录）
3. 检查是否能看到admin的聊天记录（应该看不到）
4. 再次切换到admin账号
5. 验证admin的聊天记录是否保留

### 步骤5：Redis数据验证
使用Redis客户端工具检查存储的数据：
```bash
# 查看所有AI聊天相关的键
KEYS ai_chat:*

# 查看胡淇的聊天记录
GET ai_chat:100_胡淇_班委部门

# 查看admin的聊天记录
GET ai_chat:1_admin_若依科技

# 检查过期时间
TTL ai_chat:100_胡淇_班委部门
TTL ai_chat:1_admin_若依科技
```

## 预期结果

### 1. 用户隔离
- ✅ 不同用户登录后看到的聊天记录完全独立
- ✅ 用户A无法看到用户B的聊天内容
- ✅ 切换账号后聊天记录正确切换

### 2. 数据持久化
- ✅ 用户聊天记录保存到Redis中
- ✅ 业务ID格式正确：`用户ID_用户姓名_用户部门`
- ✅ 聊天记录包含用户消息和AI回复

### 3. 过期机制
- ✅ Redis键设置了3天的过期时间
- ✅ 过期后聊天记录自动清理

### 4. API接口
- ✅ `/ai/chat` - 发送消息并获取AI回复
- ✅ `/ai/history` - 获取当前用户的聊天历史记录
- ✅ `/ai/history` (DELETE) - 清除当前用户的聊天历史记录

## 故障排查

### 问题1：聊天记录没有隔离
**可能原因**：
- SecurityUtils.getUserId() 获取用户ID失败
- 业务ID生成逻辑错误
- Redis键生成错误

**解决方案**：
- 检查用户登录状态
- 验证AiChatUtils.generateBusinessId()方法
- 查看日志中的Redis键值

### 问题2：聊天记录丢失
**可能原因**：
- Redis连接问题
- 序列化/反序列化错误
- 过期时间设置错误

**解决方案**：
- 检查Redis连接配置
- 验证FastJson2JsonRedisSerializer配置
- 确认过期时间设置（3天 = 259200秒）

### 问题3：用户信息获取失败
**可能原因**：
- 用户服务注入失败
- 用户数据不完整
- 部门信息缺失

**解决方案**：
- 检查ISysUserService注入
- 验证用户数据完整性
- 为缺失部门的用户设置默认值

## 测试完成标准
- [ ] 不同用户的聊天记录完全隔离
- [ ] 用户切换后聊天记录正确保留和切换
- [ ] Redis中存储的数据格式正确
- [ ] 业务ID生成规则符合预期
- [ ] 过期时间设置正确（3天）
- [ ] API接口功能正常
- [ ] 日志记录详细且准确