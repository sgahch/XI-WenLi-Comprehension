# 项目改造任务执行记录

## 任务概览
- **开始时间**: 2025-11-02
- **当前阶段**: 阶段二 - 课程成绩录入和维度详情展示功能
- **当前任务**: 实现课程成绩录入、维度详情展示、附件预览修复

---

## 🎉 课程成绩录入功能 + 维度详情展示功能 (完成时间: 2025-11-03)

### 📋 任务概述

**需求来源**：用户反馈
**实施时间**：2025-11-03
**实施人员**：AI Assistant

**核心需求**：
1. 学生端缺少课程成绩录入功能（智育维度只有成绩截图上传）
2. 班委审核页面只显示总分，无法查看各维度的详细成果信息
3. 附件预览功能存在问题

**解决方案**：
1. 将课程成绩作为一种特殊的评分规则，复用现有架构
2. 支持不同学院对同一课程的差异化评分标准（通过college_id字段）
3. 创建课程成绩录入组件，支持自动计算加分
4. 添加维度切换功能，支持查看各维度详细成果
5. 修复附件预览URL处理逻辑

### ✅ 已完成工作

#### 1. 数据库修改 - 添加college_id字段

**文件**：`sql/add_college_id_to_rule.sql`

**修改内容**：
- 为 `evaluation_rule` 表添加 `college_id` 字段
- 添加索引优化查询性能
- 插入示例课程成绩规则数据

#### 2. 创建课程成绩录入组件

**文件**：`ruoyi-ui/src/views/evaluation-submit/submission/components/CourseGradeInput.vue`

**功能特性**：
- ✅ 课程选择（下拉框，支持搜索）
- ✅ 成绩录入（数字输入框，0-100分）
- ✅ 自动匹配等级和加分（根据成绩和规则自动计算）
- ✅ 备注填写（可选）
- ✅ 编辑/删除操作
- ✅ 总分统计
- ✅ 空状态提示

#### 3. 修改学生填报表单 - 集成课程成绩录入

**文件**：`ruoyi-ui/src/views/evaluation-submit/submission/SubmissionForm.vue`

**修改内容**：
- 导入 `CourseGradeInput` 组件
- 智育Tab分为三个区域：成绩截图上传、课程成绩录入、其他智育成果
- 添加计算属性分离课程成绩和其他成果
- 添加处理方法合并课程成绩和其他成果

#### 4. 创建维度详情展示组件

**文件**：`ruoyi-ui/src/components/evaluation/DimensionDetailViewer.vue`

**功能特性**：
- ✅ 成果列表展示（表格形式）
- ✅ 显示类别、项目名称、等级、得分、备注
- ✅ 附件预览和下载
- ✅ 总分统计
- ✅ 空状态提示
- ✅ 图片预览对话框

#### 5. 修改班委审核页面 - 添加维度切换功能

**文件**：`ruoyi-ui/src/views/evaluation-submit/classCommittee/components/AuditDetailDialog.vue`

**修改内容**：
- 导入 `DimensionDetailViewer` 组件
- 添加 `activeDimension` 数据字段（默认智育）
- 成绩汇总卡片改造为可点击，支持切换维度
- 添加维度详情展示区域
- 添加维度切换方法和获取维度详情方法
- 添加CSS样式支持点击和激活状态

#### 6. 修复附件预览功能

**文件**：`ruoyi-ui/src/views/evaluation-submit/classCommittee/components/AuditDetailDialog.vue`

**修复内容**：
- 添加 `getAttachmentUrl` 方法处理URL拼接
- 修改 `handlePreviewCertificate` 方法，使用完整URL
- 修改 `handleDownloadCertificate` 方法，使用完整URL
- 添加调试日志

### 📊 修改文件清单

#### 新增文件
1. ✅ `sql/add_college_id_to_rule.sql` - 数据库修改脚本
2. ✅ `ruoyi-ui/src/views/evaluation-submit/submission/components/CourseGradeInput.vue` - 课程成绩录入组件
3. ✅ `ruoyi-ui/src/components/evaluation/DimensionDetailViewer.vue` - 维度详情展示组件

#### 修改文件
1. ✅ `ruoyi-ui/src/views/evaluation-submit/submission/SubmissionForm.vue` - 学生填报表单
2. ✅ `ruoyi-ui/src/views/evaluation-submit/classCommittee/components/AuditDetailDialog.vue` - 班委审核详情对话框
3. ✅ `doc/任务执行记录.md` - 任务执行记录文档

---

## 修复审核记录显示和成绩截图上传问题 (完成时间: 2025-11-03)

### ✅ 已完成工作

#### 1. 在Detail.vue中添加审核记录展示 (完成时间: 2025-11-03)

**问题**: 填报详情页面缺少审核记录展示，用户无法查看审核历史

**修改文件**:
- ✅ `ruoyi-ui/src/views/evaluation-submit/submission/components/Detail.vue`
  - 导入 `getAuditLogsBySubmissionId` API
  - 添加 `auditLogs` 数据字段
  - 添加"审核记录"卡片，使用 `el-timeline` 组件展示
  - 添加 `loadAuditLogs` 方法加载审核记录
  - 添加辅助方法：`getTimelineType`、`getTimelineIcon`、`getOperationText`、`getStatusText`

**新增功能**:
- 审核记录时间线展示
- 显示审核人、审核时间、审核操作、审核意见、状态变更
- 按时间倒序排列（最新的在上面）

---

#### 2. 修复成绩截图上传参数错误 (完成时间: 2025-11-03)

**问题**: `NumberFormatException: For input string: "undefined"` - 前端传递undefined给后端

**根本原因**:
- `GradeScreenshotUpload` 组件要求 `detailId` 参数（智育detail记录的ID）
- 但在 `SubmissionForm.vue` 中传递的是 `submissionId`（填报记录的ID）
- 导致后端接收到 `undefined`

**解决方案**: 修改组件和后端，支持通过 `submissionId` 上传成绩截图

**修改文件**:

1. ✅ `ruoyi-ui/src/components/evaluation/GradeScreenshotUpload.vue`
   - 修改 `props`，新增 `submissionId` 参数，`detailId` 改为可选
   - 修改 `uploadData` 计算属性，优先使用 `submissionId`
   - 修改 `beforeUpload` 方法，添加参数验证

2. ✅ `ruoyi-admin/src/main/java/com/ruoyi/web/controller/evaluation/EvaluationAttachmentController.java`
   - 导入 `JSONObject`、`EvaluationSubmissionDetail`、`EvaluationSubmissionDetailMapper`
   - 注入 `evaluationSubmissionDetailMapper`
   - 修改 `uploadFile` 方法签名，新增 `submissionId` 参数，`detailId` 改为可选
   - 添加逻辑：如果提供 `submissionId` 但没有 `detailId`，自动查找智育维度的detail
   - 解析 `ruleSnapshot` JSON，查找 `dimension` 字段为 `"intellectual"` 的记录
   - 如果没有找到智育成果，返回友好的错误提示

3. ✅ `ruoyi-ui/src/views/evaluation-submit/submission/SubmissionForm.vue`
   - 已正确传递 `:submission-id="submissionId"` 参数

---

### 📊 修复效果

#### 修复前 ❌
- 填报详情页面看不到审核记录
- 成绩截图上传报错：`NumberFormatException: For input string: "undefined"`
- 用户不知道审核流程和历史

#### 修复后 ✅
- ✅ 填报详情页面显示完整的审核记录时间线
- ✅ 成绩截图上传功能正常工作
- ✅ 后端智能查找智育detail，无需前端传递detailId
- ✅ 友好的错误提示（如果没有智育成果）
- ✅ 用户体验大幅提升

---

### 🎯 测试建议

1. **测试审核记录显示**:
   - 重启后端服务
   - 登录学生账号，查看填报历史
   - 点击"详情"按钮，验证是否显示审核记录时间线
   - 检查审核人、审核时间、审核操作、状态变更是否正确

2. **测试成绩截图上传**:
   - 登录学生账号，进入"综合测评填报"页面
   - 切换到"智育"Tab
   - 在顶部"成绩截图上传"区域上传成绩截图
   - 验证上传成功后是否显示在列表中
   - 验证不会再出现 `undefined` 错误

3. **测试边界情况**:
   - 创建一个新填报，不添加任何智育成果
   - 尝试上传成绩截图
   - 验证是否显示友好的错误提示："该填报记录中没有智育维度的成果，请先添加智育成果后再上传成绩截图"

---

### 🐛 新发现的问题 (2025-11-03)

#### 问题1: 成绩截图上传仍然报错"缺少必要参数：submissionId 或 detailId" ❌

**根本原因**:
- 在 `SubmissionForm.vue` 中，`submissionId` 数据字段初始值为 `null`
- 提交审核成功后，只设置了 `this.formData.id`，**没有设置 `this.submissionId`**
- 导致 `GradeScreenshotUpload` 组件接收到的 `submissionId` 为 `undefined`

**修复方案**:
- ✅ 在提交审核成功后，同时设置 `this.submissionId = response.data.id`

**修改文件**:
- ✅ `ruoyi-ui/src/views/evaluation-submit/submission/SubmissionForm.vue` (第608-616行)
  ```javascript
  if (response.data && response.data.id) {
    this.formData.id = response.data.id
    // 设置submissionId，用于成绩截图上传
    this.submissionId = response.data.id
  }
  ```

---

#### 问题2: 证明材料预览不出来 ❌

**现象**: 点击附件链接无法预览图片

**可能原因**:
1. MinIO URL配置问题
2. 附件URL格式不正确
3. 跨域问题
4. MinIO服务未启动或不可访问

**待排查**:
- 检查数据库中附件的URL格式
- 检查MinIO服务状态（`http://192.168.182.128:9000`）
- 检查浏览器控制台错误信息
- 验证`MinioResourceController`是否正常工作（`/profile/**`路径）

**建议操作**:
1. 打开浏览器开发者工具，查看网络请求
2. 检查附件URL是否正确（应该是`http://localhost:8080/profile/evaluation/2025/11/03/xxx.jpg`格式）
3. 直接在浏览器访问MinIO地址：`http://192.168.182.128:9000`
4. 检查MinIO桶名称是否为`blog`
5. 查看后端日志是否有MinIO连接错误

---

### ✅ 问题1和安全漏洞修复完成 (2025-11-03)

#### 修复内容

**1. 修复submissionId未设置问题** ✅
- **文件**: `ruoyi-ui/src/views/evaluation-submit/submission/SubmissionForm.vue`
- **修改**: 在提交审核成功后，同时设置 `this.submissionId = response.data.id`

**2. 修复班级选择安全漏洞** ✅
- **问题**: 学生可以自主选择班级，存在数据篡改风险
- **解决方案**:
  - 扩展Vuex store，添加 `deptId` 和 `dept` 信息
  - 将班级选择框改为只读输入框
  - 自动从用户信息中获取班级
- **修改文件**:
  - `ruoyi-ui/src/store/modules/user.js` - 添加deptId和dept的state和mutation
  - `ruoyi-ui/src/store/getters.js` - 添加deptId和dept的getter
  - `ruoyi-ui/src/views/evaluation-submit/submission/SubmissionForm.vue` - 班级选择框改为只读

**3. 实现自动保存草稿功能** ✅
- **设计思路**:
  - 监听基本信息变化（学年、学期、班级）
  - 当三个字段都填写完毕时，自动创建草稿记录
  - 获取 `submissionId`，用于成绩截图上传
- **实现**:
  - 添加 `watch` 监听器，监听表单字段变化
  - 添加 `checkAndAutoSaveDraft` 方法，延迟1秒后执行
  - 添加 `autoSaveDraft` 方法，调用后端API创建草稿
- **修改文件**: `ruoyi-ui/src/views/evaluation-submit/submission/SubmissionForm.vue`

**4. 实现延迟上传队列** ✅
- **设计思路**:
  - 允许用户随时选择截图文件
  - 如果没有 `submissionId`，文件暂存在前端
  - 当获取到 `submissionId` 后，自动上传队列中的文件
- **实现**:
  - 添加 `pendingFiles` 数据字段，存储待上传文件
  - 监听 `submissionId` 变化，自动触发上传
  - 修改 `beforeUpload` 方法，支持延迟上传
  - 添加 `uploadPendingFiles` 和 `uploadSingleFile` 方法
- **修改文件**: `ruoyi-ui/src/components/evaluation/GradeScreenshotUpload.vue`

**5. 添加草稿过期清理机制** ✅
- **实现**: 草稿3天后自动过期并清除
- **修改文件**: `ruoyi-ui/src/views/evaluation-submit/submission/SubmissionForm.vue`

#### 用户体验优化

**优化前的问题**:
1. ❌ 用户必须先提交审核才能上传成绩截图
2. ❌ 用户可以随意选择班级，存在安全隐患
3. ❌ 没有自动保存功能，数据容易丢失

**优化后的流程**:
1. ✅ 用户填写基本信息（学年、学期）
2. ✅ 班级自动从用户信息中获取（只读）
3. ✅ 系统自动创建草稿记录，获取 `submissionId`
4. ✅ 用户可以随时上传成绩截图（无需等待）
5. ✅ 用户添加各维度成果
6. ✅ 点击"提交审核"，更新状态为待审核

#### 测试建议

1. **测试自动保存草稿**:
   - 登录学生账号
   - 进入"综合测评填报"页面
   - 填写学年、学期（班级自动填充）
   - 等待1秒，观察是否提示"基本信息已自动保存"
   - 检查控制台，确认 `submissionId` 已获取

2. **测试延迟上传**:
   - 在自动保存前，尝试上传成绩截图
   - 应该提示"截图已选择，将在保存基本信息后自动上传"
   - 等待自动保存完成后，截图应自动上传

3. **测试班级只读**:
   - 确认班级输入框为灰色禁用状态
   - 显示当前用户所属班级名称
   - 无法修改班级

---

### ✅ 成绩截图上传优化 - 使用通用上传接口 (2025-11-03)

#### 问题分析

**用户反馈的问题**:
1. ❌ 用户选择截图后，只显示提示信息，**没有预览**
2. ❌ 文件暂存在前端，用户看不到已选择的文件
3. ❌ 用户体验不好，不知道文件是否真的被选中了

**根本原因**:
- 之前的实现需要先有 `submissionId` 才能上传截图
- 用户选择文件后，文件只是暂存在前端，没有立即上传
- 没有预览功能，用户无法确认文件是否选择成功

#### 解决方案

**采用方案B：使用RuoYi通用上传接口**

**设计思路**:
1. 用户选择截图文件
2. **立即上传到MinIO**（使用 `/common/upload` 接口）
3. **立即显示预览**（el-upload自带）
4. 前端暂存URL列表
5. 提交审核时，将URL列表传给后端
6. 后端创建附件记录时，使用前端传来的URL

**优点**:
- ✅ 不需要等待 `submissionId`
- ✅ 用户可以立即看到预览
- ✅ 用户体验最好
- ✅ 实现简单，不需要新增后端接口

#### 修改内容

**前端修改** (4个文件):

1. **`ruoyi-ui/src/components/evaluation/GradeScreenshotUpload.vue`** - 核心修改
   - 修改 `uploadUrl`，使用 `/common/upload` 接口
   - 移除 `uploadData`，不需要传递 `submissionId` 和 `detailId`
   - 简化 `beforeUpload`，只保留文件类型和大小验证
   - 修改 `handleUploadSuccess`，提取URL并触发change事件
   - 移除 `pendingFiles` 相关逻辑
   - 移除 `uploadPendingFiles` 和 `uploadSingleFile` 方法

2. **`ruoyi-ui/src/views/evaluation-submit/submission/SubmissionForm.vue`**
   - 添加 `gradeScreenshotUrls` 数据字段
   - 修改 `handleScreenshotChange` 方法，提取URL列表
   - 修改 `buildSubmissionData` 方法，包含 `gradeScreenshotUrls`

**后端修改** (2个文件):

3. **`ruoyi-system/src/main/java/com/ruoyi/system/domain/EvaluationSubmission.java`**
   - 添加 `gradeScreenshotUrls` 字段（临时字段，不映射到数据库）

4. **`ruoyi-system/src/main/java/com/ruoyi/system/service/impl/EvaluationSubmissionServiceImpl.java`**
   - 修改 `syncDetailsAndAttachments` 方法签名，添加 `gradeScreenshotUrls` 参数
   - 添加 `saveGradeScreenshots` 方法，处理成绩截图URL列表
   - 添加 `findIntellectualDetailId` 方法，查找智育维度的detailId
   - 添加 `extractFileNameFromUrl` 和 `extractFileExtension` 工具方法

#### 实现细节

**成绩截图保存逻辑**:
1. 前端上传截图到MinIO，获取URL
2. 提交审核时，将URL列表传给后端
3. 后端查找智育维度的 `detailId`
4. 为每个URL创建附件记录，关联到智育维度
5. 附件类型设置为 `GRADE_SCREENSHOT`

**数据流程**:
```
用户选择截图
    ↓
立即上传到MinIO (通用上传接口)
    ↓
获取URL并显示预览
    ↓
前端暂存URL列表
    ↓
用户点击"提交审核"
    ↓
将URL列表传给后端
    ↓
后端查找智育维度detailId
    ↓
创建附件记录并保存到数据库
    ↓
班委可以从数据库获取URL进行预览
```

#### 测试建议

1. **测试立即上传和预览**:
   - 登录学生账号
   - 进入"综合测评填报"页面
   - **无需填写任何信息**，直接切换到"智育"Tab
   - 点击上传成绩截图
   - 应该立即上传并显示预览
   - 检查控制台，确认URL已获取

2. **测试提交审核**:
   - 填写基本信息和智育成果
   - 上传成绩截图
   - 点击"提交审核"
   - 检查数据库 `evaluation_attachment` 表
   - 确认附件记录已创建，`attachment_type` 为 `GRADE_SCREENSHOT`

3. **测试班委预览**:
   - 登录班委账号
   - 进入"综合测评审核"页面
   - 查看学生的填报记录
   - 点击成绩截图链接
   - 应该能够正常预览图片

---

### ✅ 填报历史页面优化 - 显示成绩截图、提交时间和状态筛选 (2025-11-03)

#### 问题分析

**用户反馈的问题**:
1. ❌ 填报详情页面没有显示成绩截图
2. ❌ 提交时间没有更新
3. ❌ 缺少状态筛选功能
4. ❌ 需要支持按状态分类查看记录（草稿、待审核、已通过、已驳回）

**根本原因**:
- 详情页面没有显示成绩截图的UI组件
- 提交审核时没有设置 `submitTime` 字段
- 历史记录页面缺少状态筛选下拉框
- 后端查询详情时没有返回附件信息

#### 解决方案

**实施步骤**:
1. 修改SubmissionForm，提交审核时自动设置 `submitTime`
2. 修改Detail.vue，添加成绩截图显示区域
3. 修改history.vue，添加状态筛选功能
4. 修改后端selectEvaluationSubmissionById方法，返回详情和附件

#### 修改内容

**前端修改** (3个文件):

1. **`ruoyi-ui/src/views/evaluation-submit/submission/SubmissionForm.vue`**
   - 修改 `buildSubmissionData` 方法
   - 当 `status === 1`（提交审核）时，自动设置 `submitTime: new Date()`

2. **`ruoyi-ui/src/views/evaluation-submit/submission/components/Detail.vue`**
   - 添加成绩截图显示区域（在分维度分数卡片后）
   - 添加 `gradeScreenshots` 数据字段
   - 添加 `extractGradeScreenshots` 方法，从智育维度详情中提取成绩截图
   - 添加 `getImageUrl` 方法，处理图片URL
   - 添加成绩截图样式（gallery布局，支持预览）

3. **`ruoyi-ui/src/views/evaluation-submit/submission/history.vue`**
   - 添加状态筛选下拉框
   - 支持筛选：全部、草稿、待班委审核、待辅导员审核、已通过、已驳回
   - 修改 `queryParams`，添加 `status` 字段
   - 修改 `handleQuery` 方法，传递 `status` 参数
   - 修改 `resetQuery` 方法，重置状态筛选

**后端修改** (1个文件):

4. **`ruoyi-system/src/main/java/com/ruoyi/system/service/impl/EvaluationSubmissionServiceImpl.java`**
   - 修改 `selectEvaluationSubmissionById` 方法
   - 查询填报记录后，自动加载详情列表
   - 为每个详情加载附件列表
   - 将详情和附件设置到返回对象中

#### 实现细节

**成绩截图显示逻辑**:
1. 后端查询填报详情时，同时查询所有详情和附件
2. 前端接收到数据后，调用 `extractGradeScreenshots` 方法
3. 遍历所有详情，找到智育维度的详情（`dimension === 'intellectual'`）
4. 从智育维度的附件中筛选出 `attachmentType === 'GRADE_SCREENSHOT'` 的附件
5. 使用 `el-image` 组件显示截图，支持点击预览大图

**提交时间更新逻辑**:
1. 用户点击"提交审核"按钮
2. 调用 `buildSubmissionData(1)` 方法（status=1表示待审核）
3. 方法内部判断 `status === 1`，自动添加 `submitTime: new Date()`
4. 提交到后端，更新数据库

**状态筛选逻辑**:
1. 用户选择状态筛选条件
2. 点击"查询历史"按钮
3. 将 `status` 参数传递给后端
4. 后端根据 `status` 筛选记录
5. 返回符合条件的记录列表

#### 数据流程

```
用户提交审核
    ↓
前端设置submitTime
    ↓
提交到后端
    ↓
更新数据库
    ↓
用户查看历史记录
    ↓
后端查询记录（包含详情和附件）
    ↓
前端显示记录（包含提交时间、状态、成绩截图）
    ↓
用户可以按状态筛选记录
```

#### 测试建议

1. **测试提交时间更新**:
   - 登录学生账号
   - 填写综合测评表单
   - 点击"提交审核"
   - 进入"填报历史"页面
   - 确认提交时间已显示

2. **测试成绩截图显示**:
   - 登录学生账号
   - 进入"填报历史"页面
   - 点击某条记录的"详情"按钮
   - 确认成绩截图区域已显示
   - 点击截图，确认可以预览大图

3. **测试状态筛选**:
   - 进入"填报历史"页面
   - 选择"待班委审核"状态
   - 点击"查询历史"
   - 确认只显示待班委审核的记录
   - 选择"已通过"状态
   - 确认只显示已通过的记录

---

### ✅ 修复submitTime日期格式问题 (2025-11-03)

#### 问题分析

**错误信息**:
```
JSON parse error: Cannot deserialize value of type `java.util.Date` from String "2025-11-03T09:41:45.338Z":
expected format "yyyy-MM-dd HH:mm:ss"
```

**根本原因**:
- 前端发送的 `submitTime` 是 JavaScript 的 `Date` 对象
- 被序列化为 ISO 8601 格式：`2025-11-03T09:41:45.338Z`
- 后端期望的格式是：`yyyy-MM-dd HH:mm:ss`
- 导致反序列化失败

#### 解决方案

**修改内容**:

1. **`ruoyi-ui/src/views/evaluation-submit/submission/SubmissionForm.vue`**
   - 导入 `parseTime` 工具函数
   - 修改 `buildSubmissionData` 方法
   - 将 `new Date()` 格式化为 `yyyy-MM-dd HH:mm:ss` 格式的字符串

**修改前**:
```javascript
if (status === 1) {
  result.submitTime = new Date()  // ❌ 会被序列化为 ISO 8601 格式
}
```

**修改后**:
```javascript
import { parseTime } from '@/utils/ruoyi'

if (status === 1) {
  result.submitTime = parseTime(new Date(), '{y}-{m}-{d} {h}:{i}:{s}')  // ✅ 格式化为 yyyy-MM-dd HH:mm:ss
}
```

#### 测试建议

1. 填写综合测评表单
2. 点击"提交审核"
3. 确认提交成功，没有日期格式错误
4. 查看历史记录，确认提交时间正确显示

---

### ✅ 修复审核状态显示和状态筛选问题 (2025-11-03)

#### 问题分析

**用户反馈的问题**:
1. ❌ 班委审核页面的"审核状态"列显示为空
2. ❌ 填报历史页面的状态筛选不生效（点击不同状态后，记录没有变化）
3. ❌ 详情页面的成绩截图没有显示

**根本原因**:
1. **审核状态显示为空**: 缺少 `evaluation_status` 字典定义
2. **状态筛选不生效**: 前端参数传递逻辑有问题，`status=0` 时被判断为 `false`
3. **成绩截图不显示**: 需要调试确认数据是否正确返回

#### 解决方案

**实施步骤**:
1. 创建 `evaluation_status` 字典SQL脚本
2. 修复history.vue的状态筛选逻辑
3. 添加调试信息到Detail.vue

#### 修改内容

**SQL脚本** (1个文件):

1. **`sql/dict_evaluation_status.sql`** - 新建
   - 添加 `evaluation_status` 字典类型
   - 添加5个状态值：草稿(0)、待班委审核(1)、待辅导员审核(2)、已通过(3)、已驳回(4)
   - 每个状态配置对应的样式类型（info/warning/success/danger）

**前端修改** (2个文件):

2. **`ruoyi-ui/src/views/evaluation-submit/submission/history.vue`**
   - 修改 `handleQuery` 方法
   - 修复参数传递逻辑：只添加有值的参数，避免 `status=0` 被过滤
   - 添加调试信息：打印查询参数和查询结果

3. **`ruoyi-ui/src/views/evaluation-submit/submission/components/Detail.vue`**
   - 修改 `extractGradeScreenshots` 方法
   - 添加详细的调试信息：打印详情数据、智育维度详情、附件信息等
   - 帮助定位成绩截图不显示的原因

#### 实现细节

**字典配置**:
```sql
-- 字典类型
INSERT INTO sys_dict_type (dict_name, dict_type, status, create_by, create_time, remark)
VALUES ('综测状态', 'evaluation_status', '0', 'admin', sysdate(), '综合测评填报状态');

-- 字典数据
INSERT INTO sys_dict_data (dict_sort, dict_label, dict_value, dict_type, css_class, list_class, is_default, status, create_by, create_time, remark) VALUES
(1, '草稿', '0', 'evaluation_status', '', 'info', 'N', '0', 'admin', sysdate(), '草稿状态'),
(2, '待班委审核', '1', 'evaluation_status', '', 'warning', 'N', '0', 'admin', sysdate(), '待班委审核'),
(3, '待辅导员审核', '2', 'evaluation_status', '', 'warning', 'N', '0', 'admin', sysdate(), '待辅导员审核'),
(4, '已通过', '3', 'evaluation_status', '', 'success', 'N', '0', 'admin', sysdate(), '审核通过'),
(5, '已驳回', '4', 'evaluation_status', '', 'danger', 'N', '0', 'admin', sysdate(), '审核驳回');
```

**状态筛选修复**:
```javascript
// 修复前（有问题）
const params = {
  status: this.queryParams.status !== undefined ? this.queryParams.status : undefined
}
// 当 status=0 时，会被判断为 false，导致参数丢失

// 修复后（正确）
if (this.queryParams.status !== undefined && this.queryParams.status !== null) {
  params.status = this.queryParams.status
}
// 明确检查 undefined 和 null，避免 0 被过滤
```

#### 使用说明

**执行SQL脚本**:
```bash
# 方法1: 使用MySQL命令行
mysql -u root -p ry-vue < sql/dict_evaluation_status.sql

# 方法2: 使用数据库管理工具
# 打开 sql/dict_evaluation_status.sql 文件
# 复制内容到SQL执行窗口
# 执行SQL
```

**测试步骤**:
1. 执行SQL脚本添加字典
2. 重启后端服务（或清除Redis缓存）
3. 刷新浏览器
4. 查看班委审核页面，确认审核状态列正常显示
5. 在填报历史页面测试状态筛选功能
6. 打开浏览器控制台，查看调试信息
7. 根据调试信息定位成绩截图问题

#### 调试信息说明

**history.vue调试信息**:
- `查询参数:` - 显示发送给后端的参数
- `查询结果:` - 显示后端返回的数据
- `查询失败:` - 显示错误信息

**Detail.vue调试信息**:
- `开始提取成绩截图, detail:` - 显示完整的详情数据
- `详情列表:` - 显示所有详情记录
- `规则快照:` - 显示每个详情的规则快照
- `智育维度详情:` - 显示筛选出的智育维度详情
- `详情附件:` - 显示每个详情的附件列表
- `附件类型:` - 显示每个附件的类型
- `提取到的成绩截图:` - 显示最终提取的成绩截图列表

---

### ✅ 修复成绩截图显示问题 - 维度类型判断错误 (2025-11-03)

#### 问题分析

**用户反馈**:
- 成绩截图上传成功，但详情页面不显示
- 后端返回的数据中，所有附件的 `attachmentType` 都是 `"CERTIFICATE"`，没有 `"GRADE_SCREENSHOT"`

**根本原因**:
通过分析用户提供的API返回数据，发现：
1. `ruleSnapshot` 中使用的是 `dimensionType`（数字类型），而不是 `dimension`（字符串类型）
2. `dimensionType: 1` 表示智育维度（1=智育，2=德育，3=体育，4=美育，5=劳育）
3. 后端 `findIntellectualDetailId` 方法在查找 `dimension === 'intellectual'`，导致无法找到智育维度
4. 前端 `extractGradeScreenshots` 方法也在查找 `dimension === 'intellectual'`，同样无法找到智育维度
5. 因为找不到智育维度的 `detailId`，所以成绩截图附件无法保存

#### 解决方案

**修改内容**:

1. **`ruoyi-system/src/main/java/com/ruoyi/system/service/impl/EvaluationSubmissionServiceImpl.java`**
   - 修改 `findIntellectualDetailId` 方法
   - 优先检查 `dimensionType === 1`（智育维度）
   - 兼容旧版本：同时检查 `dimension === 'intellectual'`

2. **`ruoyi-ui/src/views/evaluation-submit/submission/components/Detail.vue`**
   - 修改 `extractGradeScreenshots` 方法
   - 优先检查 `dimensionType === 1`（智育维度）
   - 兼容旧版本：同时检查 `dimension === 'intellectual'`

#### 实现细节

**后端修复**:
```java
// 修复前（错误）
String dimension = ruleSnapshot.getString("dimension");
if ("intellectual".equals(dimension)) {
    return detail.getId();
}

// 修复后（正确）
// 优先检查 dimensionType（数字类型）
Integer dimensionType = ruleSnapshot.getInteger("dimensionType");
if (dimensionType != null && dimensionType == 1) {
    // dimensionType=1 表示智育维度
    return detail.getId();
}

// 兼容旧版本：检查 dimension（字符串类型）
String dimension = ruleSnapshot.getString("dimension");
if ("intellectual".equals(dimension)) {
    return detail.getId();
}
```

**前端修复**:
```javascript
// 修复前（错误）
return snapshot.dimension === 'intellectual'

// 修复后（正确）
// 检查 dimensionType（数字类型）：1=智育
if (snapshot.dimensionType === 1) {
  return true
}

// 兼容旧版本：检查 dimension（字符串类型）
if (snapshot.dimension === 'intellectual') {
  return true
}
```

#### 维度类型映射

```
dimensionType 数字 -> 维度名称
1 -> 智育 (intellectual)
2 -> 德育 (moral)
3 -> 体育 (physical)
4 -> 美育 (aesthetic)
5 -> 劳育 (labor)
```

#### 测试步骤

1. **重启后端服务**
2. **重新提交填报记录**（之前的记录因为没有保存成绩截图附件，需要重新提交）
   - 登录学生账号
   - 填写综合测评表单
   - 添加智育成果（学科竞赛、学术论文等）
   - 上传成绩截图
   - 点击"提交审核"
3. **查看详情页面**
   - 进入"填报历史"页面
   - 点击记录的"详情"按钮
   - ✅ 确认成绩截图正常显示
4. **查看控制台调试信息**
   - 打开浏览器控制台（F12）
   - 查看 `智育维度详情:` 输出，确认找到了智育维度
   - 查看 `提取到的成绩截图:` 输出，确认成功提取

---

### ✅ 修复班委审核页面成绩截图显示问题 (2025-11-03)

#### 问题分析

**用户反馈**:
- 学生端的填报历史页面可以正常显示成绩截图 ✅
- 班委审核页面的成绩截图核验区域显示"该学生未上传成绩截图" ❌

**根本原因**:
`AuditDetailDialog.vue` 组件传递给 `GradeScreenshotViewer` 的 `detailId` 参数错误：
- 传递的是 `submissionDetail.id`（填报记录ID）
- 应该传递的是智育维度的 `detailId`（详情ID）

`GradeScreenshotViewer` 组件使用 `detailId` 调用 `/evaluation/attachment/grade-screenshot/${detailId}` 接口查询成绩截图，但传入的是填报记录ID，导致查询不到数据。

#### 解决方案

**修改内容**:

1. **`ruoyi-ui/src/views/evaluation-submit/classCommittee/components/AuditDetailDialog.vue`**
   - 添加 `intellectualDetailId` 数据字段
   - 添加 `findIntellectualDetailId` 方法，从 `submissionDetail.details` 中查找智育维度的 `detailId`
   - 修改 `loadDetail` 方法，加载详情后自动查找智育维度的 `detailId`
   - 修改模板，将 `intellectualDetailId` 传递给 `GradeScreenshotViewer` 组件
   - 修改 `resetForm` 方法，重置 `intellectualDetailId`

#### 实现细节

**查找智育维度的detailId**:
```javascript
findIntellectualDetailId(submissionDetail) {
  if (!submissionDetail || !submissionDetail.details) {
    return null
  }

  for (const detail of submissionDetail.details) {
    if (detail.ruleSnapshot) {
      try {
        const snapshot = typeof detail.ruleSnapshot === 'string'
          ? JSON.parse(detail.ruleSnapshot)
          : detail.ruleSnapshot

        // 检查 dimensionType（数字类型）：1=智育
        if (snapshot.dimensionType === 1) {
          return detail.id
        }

        // 兼容旧版本：检查 dimension（字符串类型）
        if (snapshot.dimension === 'intellectual') {
          return detail.id
        }
      } catch (e) {
        console.error('解析ruleSnapshot失败:', e)
      }
    }
  }

  return null
}
```

**修改前**:
```vue
<grade-screenshot-viewer
  v-if="submissionDetail.id"
  :detail-id="submissionDetail.id"
  :grade-data="gradeDataList"
/>
```

**修改后**:
```vue
<grade-screenshot-viewer
  v-if="intellectualDetailId"
  :detail-id="intellectualDetailId"
  :grade-data="gradeDataList"
/>
```

#### 测试步骤

1. **刷新浏览器**（无需重启后端）
2. **登录班委账号**
3. **进入"班委审核"页面**
4. **点击某条记录的"审核"按钮**
5. **查看成绩截图核验区域**
   - ✅ 确认显示"已上传 X 张截图"
   - ✅ 确认可以看到成绩截图轮播图
   - ✅ 确认可以点击图片预览
6. **查看控制台调试信息**
   - 打开浏览器控制台（F12）
   - 查看 `智育维度detailId:` 输出，确认找到了正确的detailId

---

### ✅ 添加完整的调试日志链路 (2025-11-03)

#### 目的

为了方便排查成绩截图显示问题，在整个数据流链路中添加详细的调试日志，包括：
- 前端：班委审核对话框加载详情
- 前端：查找智育维度的detailId
- 前端：GradeScreenshotViewer组件加载成绩截图
- 后端：Controller层接收请求
- 后端：Service层查询数据库
- 后端：返回结果

#### 修改内容

**1. 前端 - AuditDetailDialog.vue**
- `loadDetail` 方法：添加详情加载的完整日志
- `findIntellectualDetailId` 方法：添加查找智育维度的详细日志

**2. 前端 - GradeScreenshotViewer.vue**
- `watch detailId`：监听detailId变化
- `loadScreenshots` 方法：添加加载成绩截图的完整日志，包括请求接口、返回数据、成绩截图列表等

**3. 后端 - EvaluationAttachmentController.java**
- `getGradeScreenshots` 方法：添加接收请求、查询结果、返回数据的日志

**4. 后端 - EvaluationAttachmentServiceImpl.java**
- `selectByDetailIdAndType` 方法：添加Service层查询的详细日志

#### 调试步骤文档

请按照以下步骤进行调试，并记录每一步的控制台输出：

---

**步骤1: 重启后端服务**

```bash
# 停止后端服务
# 重新启动后端服务
```

**目的**：加载新的后端日志代码

---

**步骤2: 打开浏览器控制台**

1. 打开浏览器（Chrome/Edge）
2. 按 `F12` 打开开发者工具
3. 切换到 `Console` 标签
4. 点击 `Clear console` 按钮清空控制台
5. 确保控制台过滤器设置为 `All levels`（显示所有日志级别）

---

**步骤3: 登录班委账号**

1. 访问系统登录页面
2. 使用班委账号登录
3. 进入"综合测评管理" -> "班委审核"页面

---

**步骤4: 点击"审核"按钮**

1. 在班委审核列表中，找到一条有成绩截图的记录
2. 点击该记录的"审核"按钮
3. **立即查看控制台输出**

**预期的控制台输出（前端）**：

```
=== [班委审核] 开始加载填报详情 ===
填报记录ID (submissionId): 8
后端返回的完整数据: {code: 200, msg: "查询成功", data: {...}}
填报详情 (submissionDetail): {id: 8, studentId: 103, ...}
详情列表 (details): [{id: 94, ...}, {id: 95, ...}, ...]

--- 开始查找智育维度的detailId ---
共有 5 个维度详情

检查第 1 个详情: {id: 94, ruleSnapshot: "...", ...}
  规则快照 (ruleSnapshot): {dimensionType: 1, dimension: "intellectual", ...}
  dimensionType: 1
  dimension: intellectual
  ✅ 找到智育维度！detailId = 94

✅ 找到智育维度的detailId: 94

=== [GradeScreenshotViewer] detailId 变化 ===
新的 detailId: 94

=== [GradeScreenshotViewer] 开始加载成绩截图 ===
智育维度 detailId: 94
请求接口: GET /evaluation/attachment/grade-screenshot/94
后端返回的原始响应: {code: 200, msg: "操作成功", data: [...]}
✅ 成功加载成绩截图，数量: 1
成绩截图列表:
  [1] 文件名: 0a83ec3709135c1c5e08d8a7592ea50a_20251103182220A001.jpg
      URL: http://localhost:8080/profile/upload/2025/11/03/0a83ec3709135c1c5e08d8a7592ea50a_20251103182220A001.jpg
      文件大小: 156.78 KB
      附件类型: GRADE_SCREENSHOT
      detailId: 94
=== [GradeScreenshotViewer] 加载完成 ===
```

**如果控制台输出异常**，请记录以下信息：
- 哪一步出现了问题？
- 错误信息是什么？
- `submissionId` 是多少？
- `intellectualDetailId` 是多少（如果找到了）？
- 后端返回的数据是什么？

---

**步骤5: 查看后端日志**

打开后端控制台（IDEA/Eclipse的Console窗口），查找以下日志：

**预期的后端日志输出**：

```
INFO  c.r.w.c.e.EvaluationAttachmentController - === [后端] 收到查询成绩截图请求 ===
INFO  c.r.w.c.e.EvaluationAttachmentController - 请求参数 detailId: 94
INFO  c.r.s.s.i.EvaluationAttachmentServiceImpl - --- [Service层] 查询附件 ---
INFO  c.r.s.s.i.EvaluationAttachmentServiceImpl - detailId: 94, attachmentType: GRADE_SCREENSHOT
INFO  c.r.s.s.i.EvaluationAttachmentServiceImpl - ✅ Mapper 返回 1 条记录
INFO  c.r.w.c.e.EvaluationAttachmentController - ✅ 查询成功，返回 1 张成绩截图
INFO  c.r.w.c.e.EvaluationAttachmentController - 成绩截图列表:
INFO  c.r.w.c.e.EvaluationAttachmentController -   [1] ID: 94, 文件名: 0a83ec3709135c1c5e08d8a7592ea50a_20251103182220A001.jpg, URL: http://localhost:8080/profile/upload/2025/11/03/0a83ec3709135c1c5e08d8a7592ea50a_20251103182220A001.jpg, detailId: 94, attachmentType: GRADE_SCREENSHOT
```

**如果后端日志显示异常**，请记录以下信息：
- 是否收到了请求？
- `detailId` 是多少？
- Mapper 返回了多少条记录？
- 如果返回0条，请执行以下SQL查询：

```sql
-- 查询该detailId的所有附件
SELECT * FROM evaluation_attachment WHERE detail_id = 94;

-- 查询该detailId的成绩截图附件
SELECT * FROM evaluation_attachment WHERE detail_id = 94 AND attachment_type = 'GRADE_SCREENSHOT';

-- 查询所有成绩截图附件
SELECT * FROM evaluation_attachment WHERE attachment_type = 'GRADE_SCREENSHOT';
```

---

**步骤6: 检查页面显示**

1. 滚动到"成绩截图核验"区域
2. 检查是否显示"已上传 X 张截图"
3. 检查是否可以看到成绩截图
4. 检查是否可以点击图片预览

**如果页面没有显示成绩截图**，但控制台显示"✅ 成功加载成绩截图，数量: 1"，可能的原因：
- 图片URL无法访问（检查URL是否正确）
- CSS样式问题（检查元素是否被隐藏）
- 组件渲染问题（检查Vue DevTools）

---

**步骤7: 提供调试信息**

请将以下信息提供给我：

1. **前端控制台完整输出**（从"=== [班委审核] 开始加载填报详情 ===" 到 "=== [GradeScreenshotViewer] 加载完成 ==="）
2. **后端日志完整输出**（从"=== [后端] 收到查询成绩截图请求 ===" 到成绩截图列表）
3. **数据库查询结果**（如果后端返回0条记录）
4. **页面截图**（显示成绩截图核验区域）

---

#### 常见问题排查

**问题1: 未找到智育维度的detailId**

**症状**：
```
❌ 未找到智育维度的detailId
⚠️ 未找到智育维度的detailId，成绩截图将无法显示
```

**原因**：
- `submissionDetail.details` 为空
- 所有详情的 `ruleSnapshot` 中没有 `dimensionType: 1` 或 `dimension: 'intellectual'`

**解决方案**：
- 检查后端返回的 `submissionDetail.details` 数据
- 检查 `ruleSnapshot` 字段的内容

---

**问题2: 后端返回0条记录**

**症状**：
```
⚠️ 后端返回的成绩截图列表为空
```

**原因**：
- 数据库中没有该 `detailId` 的成绩截图附件
- 附件的 `attachmentType` 不是 `GRADE_SCREENSHOT`
- 附件的 `detailId` 与请求的 `detailId` 不匹配

**解决方案**：
- 执行SQL查询检查数据库
- 重新提交填报记录（确保成绩截图正确保存）

---

**问题3: 图片无法显示**

**症状**：
- 控制台显示"✅ 成功加载成绩截图，数量: 1"
- 但页面上看不到图片

**原因**：
- 图片URL无法访问（404错误）
- 图片路径不正确
- MinIO服务未启动

**解决方案**：
- 在浏览器新标签页中直接访问图片URL
- 检查MinIO服务是否正常运行
- 检查图片文件是否存在

---

## 综测填报模块优化 (完成时间: 2025-11-03)

### ✅ 已完成工作

#### 1. 扩展EvaluationSubmission实体类 (完成时间: 2025-11-03)

**问题**: 查询填报记录时缺少学生姓名、学号、班级名称等关键信息

**修改文件**:
- ✅ `ruoyi-system/src/main/java/com/ruoyi/system/domain/EvaluationSubmission.java`
  - 添加 `studentName` 字段（学生姓名）
  - 添加 `studentNumber` 字段（学号）
  - 添加 `className` 字段（班级名称）

**新增字段**:
```java
/** 学生姓名（关联查询字段） */
@Excel(name = "学生姓名")
private String studentName;

/** 学号（关联查询字段） */
@Excel(name = "学号")
private String studentNumber;

/** 班级名称（关联查询字段） */
@Excel(name = "班级名称")
private String className;
```

---

#### 2. 更新Mapper XML关联查询 (完成时间: 2025-11-03)

**修改文件**:
- ✅ `ruoyi-system/src/main/resources/mapper/system/EvaluationSubmissionMapper.xml`
  - 更新 `resultMap`，添加新字段映射
  - 更新 `selectEvaluationSubmissionVo`，添加关联查询
  - 关联 `sys_user` 表查询学生姓名和学号
  - 关联 `sys_dept` 表查询班级名称

**关联查询SQL**:
```sql
select
    s.id,
    s.student_id,
    u.nick_name as student_name,
    u.user_name as student_number,
    s.academic_year,
    s.semester,
    s.class_id,
    d.dept_name as class_name,
    ...
from evaluation_submission s
left join sys_user u on s.student_id = u.user_id
left join sys_dept d on s.class_id = d.dept_id
```

---

#### 3. 优化前端详情组件 (完成时间: 2025-11-03)

**修改文件**:
- ✅ `ruoyi-ui/src/views/evaluation-submit/submission/components/Detail.vue`
  - 添加"学生基本信息"卡片，显示姓名、学号、班级、学年学期、提交时间
  - 添加"填报状态"卡片，显示状态、总分、审核时间、备注
  - 优化界面布局和样式

**新增功能**:
- 学生基本信息展示区域
- 填报状态信息展示区域
- 美化卡片样式

---

#### 4. 集成成绩截图上传功能 (完成时间: 2025-11-03)

**修改文件**:
- ✅ `ruoyi-ui/src/views/evaluation-submit/submission/SubmissionForm.vue`
  - 在智育Tab中添加"成绩截图上传"区域
  - 导入 `GradeScreenshotUpload` 组件
  - 添加 `gradeScreenshots` 数据字段
  - 添加 `submissionId` 字段（用于上传时关联）
  - 添加 `handleScreenshotChange` 方法处理截图变化
  - 在加载数据时设置 `submissionId`

**新增功能**:
- 成绩截图上传区域（位于智育Tab顶部）
- 上传提示和帮助信息
- 截图列表展示
- 截图预览和删除功能

**界面优化**:
- 添加图标和提示信息
- 美化卡片样式
- 响应式布局

---

### 📊 优化效果

#### 优化前 ❌
- 查看详情时看不到学生姓名、学号、班级名称
- 看不到提交时间
- 学生不知道在哪里上传成绩截图
- 界面信息不完整

#### 优化后 ✅
- ✅ 详情页面显示完整的学生基本信息（姓名、学号、班级）
- ✅ 显示提交时间和审核时间
- ✅ 学生填报表单中集成成绩截图上传功能（智育Tab）
- ✅ 界面布局清晰，信息完整
- ✅ 用户体验大幅提升

---

### 🎯 测试建议

1. **测试学生信息显示**:
   - 重启后端服务
   - 登录学生账号，查看填报历史
   - 点击"详情"按钮，验证是否显示姓名、学号、班级、提交时间

2. **测试成绩截图上传**:
   - 登录学生账号，进入"综合测评填报"页面
   - 切换到"智育"Tab
   - 在顶部"成绩截图上传"区域上传成绩截图
   - 验证上传成功后是否显示在列表中

3. **测试班委审核查看**:
   - 登录班委账号，进入"班委审核"页面
   - 点击"查看详情"，验证是否能看到学生上传的成绩截图

---

## 任务1.2: 实现成绩截图核验功能 (2天)

### ✅ 已完成工作

#### 1. 数据库修改 (完成时间: 2025-11-02)

**修改内容**:
- ✅ 创建数据库升级脚本 `sql/upgrade/v1.1.0_add_attachment_type.sql`
- ✅ 更新主SQL文件 `sql/ry-vue.sql` 中的表结构定义
- ✅ 添加 `attachment_type` 字段到 `evaluation_attachment` 表
- ✅ 添加索引 `idx_attachment_type` 以提高查询性能

**字段定义**:
```sql
`attachment_type` VARCHAR(32) NOT NULL DEFAULT 'CERTIFICATE' 
COMMENT '附件类型：CERTIFICATE-证书材料，GRADE_SCREENSHOT-成绩截图'
```

**执行SQL**:
```bash
# 在数据库中执行升级脚本
mysql -u root -p ry-vue < sql/upgrade/v1.1.0_add_attachment_type.sql
```

---

#### 2. 后端实体类更新 (完成时间: 2025-11-02)

**修改文件**:
- ✅ `ruoyi-system/src/main/java/com/ruoyi/system/domain/EvaluationAttachment.java`
  - 添加 `attachmentType` 字段
  - 添加 getter/setter 方法
  - 更新 toString() 方法

**新增常量类**:
- ✅ `ruoyi-common/src/main/java/com/ruoyi/common/constant/AttachmentTypeConstants.java`
  - 定义 `CERTIFICATE` 常量 (证书材料)
  - 定义 `GRADE_SCREENSHOT` 常量 (成绩截图)

---

#### 3. Mapper层更新 (完成时间: 2025-11-02)

**修改文件**:
- ✅ `ruoyi-system/src/main/java/com/ruoyi/system/mapper/EvaluationAttachmentMapper.java`
  - 添加 `selectByDetailIdAndType()` 方法 - 根据详情ID和附件类型查询
  - 添加 `selectByDetailId()` 方法 - 根据详情ID查询所有附件

- ✅ `ruoyi-system/src/main/resources/mapper/system/EvaluationAttachmentMapper.xml`
  - 更新 `resultMap` 添加 `attachment_type` 映射
  - 更新 `insertEvaluationAttachment` 添加 `attachment_type` 字段
  - 更新 `insertBatch` 添加 `attachment_type` 字段
  - 新增 `selectByDetailIdAndType` SQL查询
  - 新增 `selectByDetailId` SQL查询

---

### ✅ 已完成工作 (续)

#### 4. Service层实现 (完成时间: 2025-11-02)

**已创建文件**:
- ✅ `ruoyi-system/src/main/java/com/ruoyi/system/service/IEvaluationAttachmentService.java` - Service接口
  - 添加根据类型查询附件的方法
  - 添加成绩截图专用查询方法
  - 添加证书材料专用查询方法
  - 添加根据提交ID查询附件的方法

- ✅ `ruoyi-system/src/main/java/com/ruoyi/system/service/impl/EvaluationAttachmentServiceImpl.java` - Service实现
  - 实现所有查询方法
  - 添加附件类型验证逻辑
  - 自动设置默认附件类型

---

#### 5. Controller层实现 (完成时间: 2025-11-02)

**已创建文件**:
- ✅ `ruoyi-admin/src/main/java/com/ruoyi/web/controller/evaluation/EvaluationAttachmentController.java`

**已实现API**:
```java
// 上传附件(支持类型参数)
POST /evaluation/attachment/upload
参数: file, detailId, attachmentType
返回: {id, url, fileName, originalName, fileSize, fileType, attachmentType}

// 查询成绩截图
GET /evaluation/attachment/grade-screenshot/{detailId}

// 查询证书材料
GET /evaluation/attachment/certificate/{detailId}

// 查询详情的所有附件
GET /evaluation/attachment/detail/{detailId}

// 查询提交的所有附件
GET /evaluation/attachment/submission/{submissionId}

// 根据提交ID和类型查询附件
GET /evaluation/attachment/submission/{submissionId}/type/{attachmentType}

// 删除附件
DELETE /evaluation/attachment/{detailIds}
```

---

### ✅ 已完成工作 (续2)

---

#### 6. 前端API接口 (完成时间: 2025-11-02)

**已创建文件**:
- ✅ `ruoyi-ui/src/api/evaluation/attachment.js` - 附件管理API接口

---

#### 7. 前端组件 - 学生端 (完成时间: 2025-11-02)

**已创建文件**:
- ✅ `ruoyi-ui/src/components/evaluation/GradeScreenshotUpload.vue` - 成绩截图上传组件

**已实现功能**:
- ✅ 支持上传JPG/PNG格式的成绩截图
- ✅ 限制文件大小(默认5MB，可配置)
- ✅ 限制上传数量(默认3张，可配置)
- ✅ 图片卡片式展示和预览

---

#### 8. 前端组件 - 班委端 (完成时间: 2025-11-02)

**已创建文件**:
- ✅ `ruoyi-ui/src/components/evaluation/GradeScreenshotViewer.vue` - 成绩截图查看对比组件

**已实现功能**:
- ✅ 左右分栏布局（左侧截图，右侧成绩数据）
- ✅ 图片轮播和预览功能
- ✅ 成绩数据表格展示
- ✅ 核验提示说明

---

### ✅ 已完成工作 (续3)

---

#### 9. 修复编译错误 (完成时间: 2025-11-02)

**修复内容**:
- ✅ 在 `EvaluationSubmissionDetailMapper.java` 中添加 `selectBySubmissionId()` 方法
- ✅ 在 `EvaluationSubmissionDetailMapper.xml` 中添加对应的SQL查询

---

#### 10. 班委审核功能 - 前端页面 (完成时间: 2025-11-02)

**已创建文件**:
- ✅ `ruoyi-ui/src/views/evaluation-submit/classCommittee/audit.vue` - 班委审核主页面
- ✅ `ruoyi-ui/src/views/evaluation-submit/classCommittee/components/AuditDetailDialog.vue` - 审核详情对话框
- ✅ `ruoyi-ui/src/views/evaluation-submit/classCommittee/components/BatchAuditDialog.vue` - 批量审核对话框
- ✅ `ruoyi-ui/src/api/evaluation/auditLog.js` - 审核日志API接口

**已修改文件**:
- ✅ `ruoyi-ui/src/api/evaluation/submission.js` - 添加兼容性接口方法

**已实现功能**:
- ✅ 审核列表展示（支持筛选：学年、学期、状态、学生姓名）
- ✅ 统计卡片（待审核、已通过、已驳回、总计）
- ✅ 单个审核（查看详情、提交审核意见）
- ✅ 批量审核（批量通过、批量驳回）
- ✅ 成绩截图核验集成
- ✅ 审核历史时间线展示
- ✅ 分数汇总展示（德智体美劳五育）
- ✅ 自我评价展示

---

---

#### 11. 班委审核功能 - 菜单配置 (完成时间: 2025-11-02)

**已创建文件**:
- ✅ `sql/upgrade/v1.2.0_add_class_committee_audit_menu.sql` - 菜单配置SQL脚本
- ✅ `doc/班委审核菜单配置说明.md` - 详细配置说明文档

**菜单结构**:
- ✅ 主菜单: 班委审核 (menu_id=2122, perms='evaluation:classCommittee:audit')
- ✅ 按钮权限: 查询、通过、驳回、批量审核、查看详情、查看成绩截图、导出 (menu_id=2140-2146)
- ✅ 角色关联: 已为班委角色(role_id=101)分配所有菜单权限

**命名规范**:
- 路由地址: `classCommitteeAudit`
- 组件路径: `evaluation-submit/classCommittee/audit`
- 权限字符: `evaluation:classCommittee:*`
- 说明: 遵循业务功能菜单命名规范，不使用`t_`前缀（`t_`前缀仅用于代码生成器生成的表CRUD菜单）

---

## 任务1.3: 完善审核流程自动流转 (3天)

### ✅ 已完成工作

#### 1. 状态常量类 (完成时间: 2025-11-03)

**已创建文件**:
- ✅ `ruoyi-common/src/main/java/com/ruoyi/common/constant/SubmissionStatusConstants.java` - 填报状态常量
- ✅ `ruoyi-common/src/main/java/com/ruoyi/common/constant/AuditOperationConstants.java` - 审核操作常量

**功能特性**:
- ✅ 定义所有填报状态常量（草稿、待班委审核、待辅导员审核、已通过、已驳回）
- ✅ 提供状态描述获取方法
- ✅ 提供状态有效性校验方法
- ✅ 提供状态判断辅助方法（canSubmit、canEdit、isInAudit、isCompleted）

---

#### 2. 状态机管理类 (完成时间: 2025-11-03)

**已创建文件**:
- ✅ `ruoyi-system/src/main/java/com/ruoyi/system/service/SubmissionStateMachine.java` - 状态机管理

**核心功能**:
- ✅ **状态流转计算**: `calculateNextStatus()` - 根据当前状态、操作类型和审核人角色计算新状态
- ✅ **权限校验**: `canAudit()` - 验证用户是否有权限审核指定状态的记录
- ✅ **角色验证**:
  - 班委(role_id=101)只能审核status=1的记录
  - 辅导员(role_id=102)只能审核status=2的记录
  - 管理员(role_id=1)可以审核任何状态的记录
- ✅ **流转描述**: `getTransitionDescription()` - 生成状态流转的可读描述

**状态流转规则**:
```
草稿(0) --提交--> 待班委审核(1)
待班委审核(1) --班委通过--> 待辅导员审核(2)
待班委审核(1) --班委驳回--> 已驳回(4)
待辅导员审核(2) --辅导员通过--> 已通过(3)
待辅导员审核(2) --辅导员驳回--> 已驳回(4)
已驳回(4) --重新提交--> 待班委审核(1)
```

---

#### 3. 审核Service更新 (完成时间: 2025-11-03)

**已修改文件**:
- ✅ `ruoyi-system/src/main/java/com/ruoyi/system/service/impl/EvaluationSubmissionServiceImpl.java`

**改进内容**:
- ✅ 集成状态机管理类
- ✅ 在审核前进行权限校验
- ✅ 使用状态机计算新状态（替换原有的硬编码逻辑）
- ✅ 增加状态流转描述到返回结果
- ✅ 增加状态描述到返回结果（oldStatusDesc、newStatusDesc）
- ✅ 改进异常处理（区分业务异常和系统异常）

**关键代码**:
```java
// 验证审核权限
if (!submissionStateMachine.canAudit(oldStatus, auditorRoleIds)) {
    throw new RuntimeException("您无权审核此记录。当前状态: " + SubmissionStatusConstants.getStatusDesc(oldStatus));
}

// 使用状态机计算新状态
newStatus = submissionStateMachine.calculateNextStatus(oldStatus, auditRequest.getOperation(), auditorRoleIds);
```

---

## 任务1.3: Bug修复 - attachment_type字段为null问题 (完成时间: 2025-11-03)

### ✅ 已完成工作

#### 1. 后端修复 - 设置attachment_type默认值

**已修改文件**:
- ✅ `ruoyi-system/src/main/java/com/ruoyi/system/service/impl/EvaluationSubmissionServiceImpl.java`

**修复内容**:
- ✅ 在插入附件时，如果 `attachment_type` 为空，自动设置为 `CERTIFICATE`（证书材料）
- ✅ 确保所有通过学生填报提交的附件都有正确的类型标识

**关键代码**:
```java
// 确保 attachment_type 字段不为空（默认为证书材料）
if (att.getAttachmentType() == null || att.getAttachmentType().trim().isEmpty()) {
    att.setAttachmentType(com.ruoyi.common.constant.AttachmentTypeConstants.CERTIFICATE);
}
```

---

#### 2. 前端增强 - 班委审核时预览证明材料

**已修改文件**:
- ✅ `ruoyi-ui/src/views/evaluation-submit/classCommittee/components/AuditDetailDialog.vue`

**新增功能**:
- ✅ 在审核详情对话框中添加"证明材料"展示区域
- ✅ 显示学生上传的所有证明材料（文件名、大小、类型、上传时间）
- ✅ 支持图片文件的在线预览
- ✅ 支持所有文件的下载功能
- ✅ 美观的文件列表展示，带文件图标和悬停效果

**功能特性**:
- 📄 **文件列表展示**: 显示文件名、大小、类型、上传时间
- 🖼️ **图片预览**: JPG/PNG/JPEG格式支持在线预览
- ⬇️ **文件下载**: 所有文件都支持下载
- 🎨 **美观界面**: 文件图标、悬停效果、响应式布局

**API集成**:
- 调用 `getCertificates(submissionId)` 加载证明材料列表
- 支持按 `attachment_type='CERTIFICATE'` 筛选

---

### 📊 问题解决方案总结

#### 问题1: attachment_type字段为null

**原因分析**:
- 学生提交填报时使用的是通用的 `FileUpload` 组件
- 该组件调用的是 `/common/upload` 接口，而不是 `/evaluation/attachment/upload` 接口
- 因此附件记录在插入数据库时，`attachment_type` 字段没有被设置

**解决方案**:
- 在 `EvaluationSubmissionServiceImpl` 的附件插入逻辑中添加默认值设置
- 如果 `attachment_type` 为空，自动设置为 `CERTIFICATE`
- 这样确保了向后兼容性，不需要修改前端代码

#### 问题2: 班委无法预览学生上传的证明材料

**原因分析**:
- 原审核详情对话框只有成绩截图核验功能
- 没有展示学生上传的证明材料（如获奖证书、活动照片等）

**解决方案**:
- 在审核详情对话框中添加"证明材料"卡片
- 调用 `getCertificates` API 加载证明材料列表
- 提供预览和下载功能，方便班委核验

---

### 🔄 待集成工作

---

### ⏳ 待开始工作

#### 8. 测试 (预计0.5天)

**测试内容**:
- [ ] 数据库字段测试
- [ ] 附件上传测试(证书和截图)
- [ ] 附件查询测试
- [ ] 前端上传功能测试
- [ ] 前端查看对比功能测试
- [ ] 权限测试(学生只能上传自己的，班委可以查看本班所有)

---

## 下一步计划

1. **立即执行**: 完成Service层和Controller层实现
2. **今日目标**: 完成后端所有接口开发
3. **明日目标**: 完成前端页面开发和测试

---

## 遇到的问题和解决方案

### 问题1: 数据库字段位置
**问题描述**: 需要确定 `attachment_type` 字段在表中的位置  
**解决方案**: 将字段放在 `file_type` 之后，保持逻辑相关性

### 问题2: 默认值设置
**问题描述**: 现有数据如何处理  
**解决方案**: 设置默认值为 'CERTIFICATE'，升级脚本中更新现有数据

---

## 相关文件清单

### 已修改文件
1. `sql/ry-vue.sql` - 主数据库文件
2. `ruoyi-system/src/main/java/com/ruoyi/system/domain/EvaluationAttachment.java` - 实体类
3. `ruoyi-system/src/main/java/com/ruoyi/system/mapper/EvaluationAttachmentMapper.java` - Mapper接口
4. `ruoyi-system/src/main/resources/mapper/system/EvaluationAttachmentMapper.xml` - Mapper XML

### 新增文件
1. `sql/upgrade/v1.1.0_add_attachment_type.sql` - 数据库升级脚本
2. `ruoyi-common/src/main/java/com/ruoyi/common/constant/AttachmentTypeConstants.java` - 常量类

### 待创建/修改文件
1. Service层接口和实现类
2. Controller层接口
3. 前端学生端提交组件
4. 前端班委端查看组件

---

**最后更新时间**: 2025-11-02  
**当前进度**: 40% (数据库和Mapper层已完成)

